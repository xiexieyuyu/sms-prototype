<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMS - Â§ñË¥∏Â∞èÂÆ∂Áîµ‰æõÂ∫îÂïÜÁÆ°ÁêÜÁ≥ªÁªü</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif; font-size: 14px; line-height: 1.5; color: #262626; background: #F5F6FA; }
    a { color: #1890FF; text-decoration: none; cursor: pointer; }
    a:hover { color: #40a9ff; }
    button { font-family: inherit; font-size: inherit; cursor: pointer; border: none; outline: none; background: none; }
    input, select, textarea { font-family: inherit; font-size: inherit; outline: none; }
    #app { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    .topbar { position: fixed; top: 0; left: 0; right: 0; height: 64px; background: #fff; border-bottom: 1px solid #F0F0F0; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; z-index: 1000; }
    .topbar.client-mode-active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-bottom: none; }
    .topbar.client-mode-active .topbar-logo, .topbar.client-mode-active .topbar-username, .topbar.client-mode-active .topbar-role { color: #fff; }
    .topbar-left { display: flex; align-items: center; gap: 16px; }
    .topbar-logo { font-size: 20px; font-weight: bold; color: #1890FF; cursor: pointer; }
    .topbar-menu-toggle { display: none; font-size: 24px; cursor: pointer; color: #595959; }
    .topbar.client-mode-active .topbar-menu-toggle { color: #fff; }
    .topbar-client-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 16px; background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 20px; font-size: 14px; color: #fff; font-weight: bold; }
    .topbar-right { display: flex; align-items: center; gap: 16px; }
    .topbar-client-mode { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: #FAFAFA; border: 1px solid #D9D9D9; border-radius: 20px; font-size: 13px; color: #595959; cursor: pointer; transition: all 0.2s; }
    .topbar-client-mode:hover { border-color: #1890FF; color: #1890FF; }
    .topbar-client-mode.active { background: #fff; border-color: #fff; color: #667eea; }
    .topbar-user { display: flex; align-items: center; gap: 8px; }
    .topbar-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 14px; }
    .topbar.client-mode-active .topbar-avatar { border: 2px solid #fff; }
    .topbar-username { font-size: 14px; color: #262626; }
    .topbar-role { font-size: 12px; color: #8C8C8C; }
    .topbar-logout { padding: 6px 12px; background: #fff; border: 1px solid #D9D9D9; border-radius: 6px; color: #595959; cursor: pointer; transition: all 0.2s; }
    .topbar-logout:hover { color: #FF4D4F; border-color: #FF4D4F; }
    .topbar.client-mode-active .topbar-logout { background: rgba(255,255,255,0.2); border-color: #fff; color: #fff; }
    .sidebar { position: fixed; top: 64px; left: 0; bottom: 0; width: 240px; background: #fff; border-right: 1px solid #F0F0F0; overflow-y: auto; z-index: 999; transition: transform 0.3s; }
    .sidebar.hidden { transform: translateX(-100%); }
    .sidebar-section { padding: 16px 0; border-bottom: 1px solid #F0F0F0; }
    .sidebar-section:last-child { border-bottom: none; }
    .sidebar-section-title { padding: 0 24px 8px; font-size: 12px; color: #8C8C8C; text-transform: uppercase; }
    .sidebar-menu-item { display: flex; align-items: center; gap: 8px; padding: 12px 24px; color: #595959; cursor: pointer; transition: all 0.2s; position: relative; }
    .sidebar-menu-item:hover { background: #F5F6FA; color: #1890FF; }
    .sidebar-menu-item.active { background: #E6F7FF; color: #1890FF; }
    .sidebar-menu-item.active::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: #1890FF; }
    .main-content { margin-top: 64px; margin-left: 240px; padding: 24px; min-height: calc(100vh - 64px); overflow-y: auto; transition: margin-left 0.3s; }
    .main-content.no-sidebar { margin-left: 0; }
    .main-content.full-width { margin-left: 0; }
    .card { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 24px; }
    .card-header { padding: 24px; border-bottom: 1px solid #F0F0F0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
    .card-title { font-size: 20px; font-weight: bold; color: #262626; }
    .card-subtitle { margin-top: 4px; font-size: 14px; color: #8C8C8C; }
    .card-body { padding: 24px; }
    .card-actions { display: flex; gap: 12px; flex-wrap: wrap; }
    .btn { padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; border: none; }
    .btn-primary { background: #1890FF; color: #fff; }
    .btn-primary:hover { background: #40a9ff; }
    .btn-primary:disabled { background: #D9D9D9; cursor: not-allowed; }
    .btn-default { background: #fff; color: #595959; border: 1px solid #D9D9D9; }
    .btn-default:hover { color: #1890FF; border-color: #1890FF; }
    .btn-danger { background: #FF4D4F; color: #fff; }
    .btn-danger:hover { background: #ff7875; }
    .btn-lg { padding: 12px 24px; font-size: 16px; }
    .btn-sm { padding: 4px 8px; font-size: 12px; }
    .tag { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 20px; font-size: 13px; white-space: nowrap; }
    .tag-blue { background: #E6F7FF; color: #1890FF; }
    .tag-green { background: #F6FFED; color: #52C41A; }
    .tag-orange { background: #FFF7E6; color: #FA8C16; }
    .tag-red { background: #FFF1F0; color: #FF4D4F; }
    .tag-purple { background: #F9F0FF; color: #722ED1; }
    .tag-cyan { background: #E6FFFB; color: #13C2C2; }
    .tag-gray { background: #FAFAFA; color: #8C8C8C; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: #262626; }
    .form-label-required::after { content: ' *'; color: #FF4D4F; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 8px 12px; border: 1px solid #D9D9D9; border-radius: 6px; transition: all 0.2s; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: #1890FF; box-shadow: 0 0 0 2px rgba(24,144,255,0.1); }
    .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    .form-row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .checkbox-item { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .checkbox-item input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
    .list-item { padding: 16px; border: 1px solid #F0F0F0; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; background: #fff; transition: all 0.2s; }
    .list-item:hover { border-color: #1890FF; box-shadow: 0 2px 8px rgba(24,144,255,0.1); }
    .list-item-content { flex: 1; }
    .list-item-actions { display: flex; gap: 8px; }
    .list-item-indent { margin-left: 32px; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); z-index: 2000; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: #fff; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-lg { max-width: 900px; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid #F0F0F0; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 18px; font-weight: bold; color: #262626; }
    .modal-close { font-size: 20px; cursor: pointer; color: #8C8C8C; }
    .modal-close:hover { color: #262626; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid #F0F0F0; display: flex; justify-content: flex-end; gap: 12px; }
    .filter-bar { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px; }
    .filter-row { display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap; }
    .filter-item { flex: 0 0 auto; min-width: 200px; }
    .filter-item.flex-1 { flex: 1; min-width: 200px; }
    .grid { display: grid; gap: 24px; }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .product-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; transition: all 0.2s; position: relative; }
    .product-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); transform: translateY(-2px); }
    .product-card-checkbox { position: absolute; top: 12px; left: 12px; width: 20px; height: 20px; z-index: 10; }
    .product-card-selected { border: 2px solid #1890FF; box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.2); }
    .product-card-image { height: 200px; display: flex; align-items: center; justify-content: center; font-size: 80px; background: #F5F6FA; }
    .product-card-body { padding: 16px; }
    .product-card-name { font-size: 16px; font-weight: bold; margin-bottom: 4px; color: #262626; }
    .product-card-sku { font-size: 13px; color: #8C8C8C; margin-bottom: 12px; }
    .product-card-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    .product-card-price { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid #F0F0F0; }
    .product-card-price-label { font-size: 12px; color: #8C8C8C; }
    .product-card-price-value { font-size: 18px; font-weight: bold; color: #1890FF; }
    .vendor-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; transition: all 0.2s; }
    .vendor-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); transform: translateY(-2px); }
    .vendor-card-header { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; text-align: center; }
    .vendor-card-icon { font-size: 48px; margin-bottom: 8px; }
    .vendor-card-name { font-size: 16px; font-weight: bold; }
    .vendor-card-body { padding: 16px; }
    .vendor-card-info { display: flex; flex-direction: column; gap: 8px; font-size: 13px; color: #595959; }
    .vendor-card-info-item { display: flex; align-items: center; gap: 8px; }
    .vendor-card-rating { color: #FAAD14; }
    .vendor-card-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 12px; }
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    thead { background: #FAFAFA; }
    th { padding: 16px; text-align: left; font-weight: 600; color: #262626; border-bottom: 1px solid #F0F0F0; white-space: nowrap; }
    td { padding: 16px; border-bottom: 1px solid #F0F0F0; }
    tbody tr { transition: background 0.2s; }
    tbody tr:hover { background: #F0F7FF; }
    .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px; }
    .info-item { display: flex; flex-direction: column; gap: 4px; }
    .info-label { font-size: 13px; color: #8C8C8C; }
    .info-value { font-size: 14px; color: #262626; font-weight: 500; }
    .section { margin-bottom: 32px; }
    .section-title { font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #262626; }
    .alert { padding: 16px; border-radius: 8px; margin-bottom: 16px; }
    .alert-info { background: #E6F7FF; border-left: 4px solid #1890FF; }
    .alert-warning { background: #FFF7E6; border-left: 4px solid #FA8C16; }
    .alert-success { background: #F6FFED; border-left: 4px solid #52C41A; }
    .alert-error { background: #FFF1F0; border-left: 4px solid #FF4D4F; }
    .compare-container { overflow-x: auto; }
    .compare-table { min-width: 800px; border-collapse: separate; border-spacing: 0; width: 100%; }
    .compare-table thead th { position: sticky; top: 0; background: #FAFAFA; z-index: 20; }
    .compare-table th:first-child, .compare-table td:first-child { position: sticky; left: 0; background: #FAFAFA; z-index: 10; }
    .compare-product-header { text-align: center; padding: 16px; }
    .compare-product-icon { font-size: 48px; margin-bottom: 8px; }
    .compare-product-name { font-size: 14px; font-weight: bold; margin-bottom: 4px; }
    .compare-product-sku { font-size: 12px; color: #8C8C8C; margin-bottom: 8px; }
    .compare-remove { color: #FF4D4F; font-size: 12px; cursor: pointer; }
    .media-main { height: 400px; background: #F5F6FA; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 120px; margin-bottom: 24px; }
    .login-container { display: flex; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .login-brand { flex: 0 0 40%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; padding: 48px; }
    .login-brand-logo { font-size: 64px; font-weight: bold; margin-bottom: 24px; }
    .login-brand-title { font-size: 28px; font-weight: bold; margin-bottom: 12px; }
    .login-brand-subtitle { font-size: 16px; opacity: 0.9; }
    .login-form-section { flex: 1; display: flex; justify-content: center; align-items: center; background: #fff; padding: 48px; }
    .login-form-wrapper { width: 100%; max-width: 400px; }
    .login-form-title { font-size: 24px; font-weight: bold; margin-bottom: 32px; text-align: center; }
    .login-test-accounts { margin-top: 24px; padding: 16px; background: #E6F7FF; border-left: 4px solid #1890FF; border-radius: 6px; }
    .login-test-accounts-title { font-weight: bold; margin-bottom: 8px; color: #0050B3; }
    .login-test-account { display: flex; justify-content: space-between; padding: 4px 0; color: #096DD9; font-size: 13px; }
    .stat-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 24px; }
    .stat-card { background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .stat-card-icon { font-size: 32px; margin-bottom: 12px; }
    .stat-card-value { font-size: 28px; font-weight: bold; color: #262626; margin-bottom: 4px; }
    .stat-card-label { font-size: 14px; color: #8C8C8C; }
    .tabs { display: flex; border-bottom: 1px solid #F0F0F0; margin-bottom: 24px; }
    .tab { padding: 12px 24px; cursor: pointer; color: #595959; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .tab:hover { color: #1890FF; }
    .tab.active { color: #1890FF; border-bottom-color: #1890FF; }
    .placeholder-page { text-align: center; padding: 60px 24px; }
    .placeholder-icon { font-size: 80px; margin-bottom: 24px; }
    .placeholder-title { font-size: 24px; font-weight: bold; margin-bottom: 12px; color: #262626; }
    .placeholder-desc { font-size: 16px; color: #8C8C8C; margin-bottom: 32px; }
    .toast { position: fixed; top: 80px; right: 24px; padding: 12px 24px; background: #fff; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); z-index: 3000; display: none; }
    .toast.show { display: block; }
    .toast-success { border-left: 4px solid #52C41A; }
    .toast-error { border-left: 4px solid #FF4D4F; }
    .price-notification-bubble { position: fixed; bottom: 0; left: 0; width: 240px; z-index: 999; background: #fff; border-right: 1px solid #F0F0F0; }
    .price-notification-toggle { display: none; }
    .price-notification-toggle:hover { }
    .price-notification-toggle .icon { }
    .price-notification-badge { display: none; }
    .price-notification-panel { position: relative; bottom: auto; left: auto; width: 100%; background: #fff; border-radius: 0; box-shadow: none; display: block; overflow: hidden; border-top: 1px solid #F0F0F0; }
    .price-notification-panel.active { display: block; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .price-notification-header { padding: 12px 16px; background: linear-gradient(135deg, #FF6B6B 0%, #FF4D4F 100%); color: #fff; }
    .price-notification-header-title { font-size: 13px; font-weight: bold; }
    .price-notification-header-subtitle { font-size: 11px; opacity: 0.9; margin-top: 2px; }
    .price-notification-list { max-height: 200px; overflow-y: auto; }
    .price-notification-item { padding: 10px 12px; border-bottom: 1px solid #F0F0F0; cursor: pointer; transition: background 0.2s; }
    .price-notification-item:hover { background: #FFF7E6; }
    .price-notification-item:last-child { border-bottom: none; }
    .price-notification-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .price-notification-item-product { font-weight: bold; color: #262626; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }
    .price-notification-item-date { font-size: 10px; color: #8C8C8C; }
    .price-notification-item-price { display: flex; align-items: center; gap: 6px; }
    .price-notification-item-old { color: #8C8C8C; text-decoration: line-through; font-size: 12px; }
    .price-notification-item-arrow { color: #FF4D4F; font-size: 12px; }
    .price-notification-item-new { color: #FF4D4F; font-weight: bold; font-size: 13px; }
    .price-notification-item-reason { font-size: 11px; color: #595959; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .price-attachment { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: #F5F6FA; border-radius: 4px; font-size: 11px; color: #1890FF; cursor: pointer; margin-right: 4px; margin-top: 4px; }
    .price-attachment:hover { background: #E6F7FF; }
    @media (max-width: 1200px) { .stat-cards { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 1024px) { .topbar-menu-toggle { display: block; } .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); } .main-content { margin-left: 0; } .login-brand { display: none; } .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); } .info-grid, .form-row, .form-row-3 { grid-template-columns: 1fr; } }
    @media (max-width: 768px) { .topbar { padding: 0 16px; } .topbar-username, .topbar-role { display: none; } .main-content { padding: 16px; } .card-body { padding: 16px; } .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } .filter-row { flex-direction: column; } .filter-item { width: 100%; } .stat-cards { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="toast" class="toast"></div>
  <div id="priceNotificationBubble" class="price-notification-bubble" style="display: none;">
    <div class="price-notification-panel active" id="priceNotificationPanel">
      <div class="price-notification-header">
        <div class="price-notification-header-title">üìä ‰ª∑Ê†ºÂèòÊõ¥ÈÄöÁü•</div>
        <div class="price-notification-header-subtitle">ÊúÄËøë5Ê¨°Âá∫ÂéÇ‰ª∑Ë∞ÉÊï¥</div>
      </div>
      <div class="price-notification-list" id="priceNotificationList"></div>
    </div>
  </div>
  <div id="clientModeModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header"><div class="modal-title">üîí ÂÖ≥Èó≠ÂÆ¢Êà∑ÊºîÁ§∫Ê®°Âºè</div></div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">ËØ∑ËæìÂÖ•ÂΩìÂâçË¥¶Âè∑ÂØÜÁ†Å‰ª•ÂÖ≥Èó≠ÊºîÁ§∫Ê®°Âºè</label>
          <input type="password" id="clientModePassword" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å">
        </div>
        <div id="clientModeError" style="color: #FF4D4F; font-size: 13px; margin-top: 8px; display: none;">ÂØÜÁ†ÅÈîôËØØ,ËØ∑ÈáçËØï</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-default" onclick="cancelClientModeClose()">ÂèñÊ∂à</button>
        <button class="btn btn-primary" onclick="confirmClientModeClose()">Á°ÆËÆ§</button>
      </div>
    </div>
  </div>
  <div id="editModal" class="modal-overlay">
    <div class="modal modal-lg">
      <div class="modal-header">
        <div class="modal-title" id="editModalTitle">ÁºñËæë</div>
        <span class="modal-close" onclick="closeEditModal()">√ó</span>
      </div>
      <div class="modal-body" id="editModalBody"></div>
      <div class="modal-footer">
        <button class="btn btn-default" onclick="closeEditModal()">ÂèñÊ∂à</button>
        <button class="btn btn-primary" onclick="saveEdit()">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>
  <script>
    const db = {
      users: [
        { id: 1, username: "admin", demoPassword: "123456", realName: "Âº†ÁÆ°ÁêÜ", role: "admin", avatar: "Âº†", avatarBg: "#1890FF", status: "active", phone: "138-0000-0001", email: "admin@sms.com" },
        { id: 2, username: "sales", demoPassword: "123456", realName: "Êùé‰∏öÂä°", role: "sales", avatar: "Êùé", avatarBg: "#52C41A", status: "active", phone: "138-0000-0002", email: "sales@sms.com" },
        { id: 3, username: "sales2", demoPassword: "123456", realName: "ÁéãÈîÄÂîÆ", role: "sales", avatar: "Áéã", avatarBg: "#FA8C16", status: "active", phone: "138-0000-0003", email: "sales2@sms.com" }
      ],
      categories: [
        { id: 1, name: "Âé®ÊàøÁîµÂô®", parentId: null, sortOrder: 1, enabled: true, templateKey: null },
        { id: 2, name: "Ê¶®Ê±ÅÊú∫", parentId: 1, templateKey: "juicer", sortOrder: 11, enabled: true },
        { id: 5, name: "ÂíñÂï°Êú∫", parentId: 1, templateKey: "coffee", sortOrder: 14, enabled: true },
        { id: 6, name: "Á©∫Ê∞îÁÇ∏ÈîÖ", parentId: 1, templateKey: "airfryer", sortOrder: 15, enabled: true },
        { id: 10, name: "Ê∏ÖÊ¥ÅÁîµÂô®", parentId: null, sortOrder: 2, enabled: true, templateKey: null },
        { id: 11, name: "Âê∏Â∞òÂô®", parentId: 10, templateKey: "vacuum", sortOrder: 21, enabled: true },
        { id: 12, name: "Êâ´Âú∞Êú∫Âô®‰∫∫", parentId: 10, templateKey: "robot", sortOrder: 22, enabled: true },
        { id: 13, name: "Ëí∏Ê±ΩÊãñÊää", parentId: 10, templateKey: "steammop", sortOrder: 23, enabled: true },
        { id: 14, name: "Â∏ÉËâ∫Ê∏ÖÊ¥óÊú∫", parentId: 10, templateKey: "fabriccleaner", sortOrder: 24, enabled: true }
      ],
      tags: [
        { id: 1, name: "ÁÉ≠ÈîÄ", group: "feature", color: "#FA8C16", bgColor: "#FFF7E6", visibleTo: ["admin", "sales", "client"], enabled: true },
        { id: 2, name: "OEMÂèØÂÆöÂà∂", group: "strategy", color: "#52C41A", bgColor: "#F6FFED", visibleTo: ["admin", "sales"], enabled: true },
        { id: 3, name: "Êñ∞ÂìÅ", group: "feature", color: "#1890FF", bgColor: "#E6F7FF", visibleTo: ["admin", "sales", "client"], enabled: true },
        { id: 4, name: "Áã¨ÂÆ∂", group: "status", color: "#722ED1", bgColor: "#F9F0FF", visibleTo: ["admin"], enabled: true },
        { id: 5, name: "ÁéØ‰øù", group: "feature", color: "#13C2C2", bgColor: "#E6FFFB", visibleTo: ["admin", "sales", "client"], enabled: true },
        { id: 6, name: "ÈùôÈü≥", group: "feature", color: "#52C41A", bgColor: "#F6FFED", visibleTo: ["admin", "sales", "client"], enabled: true },
        { id: 7, name: "CEËÆ§ËØÅ", group: "certification", color: "#1890FF", bgColor: "#E6F7FF", visibleTo: ["admin", "sales", "client"], enabled: true },
        { id: 8, name: "RoHSËÆ§ËØÅ", group: "certification", color: "#1890FF", bgColor: "#E6F7FF", visibleTo: ["admin", "sales", "client"], enabled: true }
      ],
      templates: [
        { id: 1, templateKey: "vacuum", name: "Âê∏Â∞òÂô®ÂèÇÊï∞Ê®°Êùø", enabled: true, parameters: [
          { fieldKey: "power", label: "ÂäüÁéá", type: "number", unit: "W", required: true },
          { fieldKey: "battery_capacity", label: "ÁîµÊ±†ÂÆπÈáè", type: "number", unit: "mAh", required: true },
          { fieldKey: "voltage", label: "ÁîµÂéã", type: "number", unit: "V", required: true },
          { fieldKey: "runtime", label: "Áª≠Ëà™Êó∂Èó¥", type: "number", unit: "min", required: true },
          { fieldKey: "dust_capacity", label: "Â∞òÊùØÂÆπÈáè", type: "number", unit: "ml", required: true },
          { fieldKey: "weight", label: "ÂáÄÈáç", type: "number", unit: "kg", required: true },
          { fieldKey: "noise_level", label: "Âô™Èü≥Á≠âÁ∫ß", type: "number", unit: "dB", required: false }
        ]},
        { id: 2, templateKey: "juicer", name: "Ê¶®Ê±ÅÊú∫ÂèÇÊï∞Ê®°Êùø", enabled: true, parameters: [
          { fieldKey: "power", label: "ÂäüÁéá", type: "number", unit: "W", required: true },
          { fieldKey: "capacity", label: "ÂÆπÈáè", type: "number", unit: "ml", required: true },
          { fieldKey: "voltage", label: "ÁîµÂéã", type: "number", unit: "V", required: true },
          { fieldKey: "speed", label: "ËΩ¨ÈÄü", type: "number", unit: "RPM", required: true },
          { fieldKey: "weight", label: "ÂáÄÈáç", type: "number", unit: "kg", required: true }
        ]},
        { id: 3, templateKey: "airfryer", name: "Á©∫Ê∞îÁÇ∏ÈîÖÂèÇÊï∞Ê®°Êùø", enabled: true, parameters: [
          { fieldKey: "power", label: "ÂäüÁéá", type: "number", unit: "W", required: true },
          { fieldKey: "capacity", label: "ÂÆπÈáè", type: "number", unit: "ml", required: true },
          { fieldKey: "voltage", label: "ÁîµÂéã", type: "number", unit: "V", required: true },
          { fieldKey: "temp_range", label: "Ê∏©Â∫¶ËåÉÂõ¥", type: "text", unit: "", required: true },
          { fieldKey: "weight", label: "ÂáÄÈáç", type: "number", unit: "kg", required: true }
        ]}
      ],
      vendors: [
        { id: 1, name: "Ê∑±Âú≥Ê∏ÖÊ¥ÅËÆæÂ§áÁßëÊäÄÊúâÈôêÂÖ¨Âè∏", icon: "üè≠", rating: 4, established: 2015, location: { province: "Âπø‰∏úÁúÅ", city: "Ê∑±Âú≥Â∏Ç", district: "ÂÆùÂÆâÂå∫" }, address: "Âπø‰∏úÁúÅÊ∑±Âú≥Â∏ÇÂÆùÂÆâÂå∫Ë•ø‰π°Ë°óÈÅìÂõ∫ÊàçÁ§æÂå∫ÂÆùÊ∫êË∑Ø1Âè∑FÊ†ã", mainCategories: ["Âê∏Â∞òÂô®", "Êâ´Âú∞Êú∫Âô®‰∫∫", "Ëí∏Ê±ΩÊãñÊää"], cooperatedBrands: ["Philips", "Midea", "Bear"], factoryCerts: ["ISO 9001", "BSCI"], productComplianceExperience: ["CE", "RoHS", "FCC", "UL"], productCount: 4, cooperationYears: 3, avgLeadTime: 30, media: [{ type: "image", title: "Â∑•ÂéÇÂ§ñËßÇ", url: "üè≠" }, { type: "image", title: "Áîü‰∫ßËΩ¶Èó¥", url: "‚öôÔ∏è" }, { type: "image", title: "Ë¥®Ê£Ä‰∏≠ÂøÉ", url: "üî¨" }, { type: "video", title: "Â∑•ÂéÇ‰ªãÁªçËßÜÈ¢ë", url: "üé¨" }], adminOnly: { legalPerson: "ÁéãÂª∫ÂõΩ", capitalCNY: 5000000, employeesRange: { min: 50, max: 100 }, contact: { person: "ÁéãÊÄª", position: "ÊÄªÁªèÁêÜ", phone: "0755-8888-6666", mobile: "138-0000-8888", email: "wang@szcleaner.com" } } },
        { id: 2, name: "ÊµôÊ±üÂé®ÁîµÊô∫ÈÄ†ÊúâÈôêÂÖ¨Âè∏", icon: "üè≠", rating: 5, established: 2012, location: { province: "ÊµôÊ±üÁúÅ", city: "ÂÆÅÊ≥¢Â∏Ç", district: "ÊÖàÊ∫™Â∏Ç" }, address: "ÊµôÊ±üÁúÅÂÆÅÊ≥¢Â∏ÇÊÖàÊ∫™Â∏ÇËßÇÊµ∑Âç´ÈïáÂ∑•‰∏öÂõ≠Âå∫ÂàõÊñ∞Ë∑Ø88Âè∑", mainCategories: ["Ê¶®Ê±ÅÊú∫", "Á†¥Â£ÅÊú∫", "ÊêÖÊãåÊú∫"], cooperatedBrands: ["Midea", "Joyoung", "Bear"], factoryCerts: ["ISO 9001", "ISO 14001"], productComplianceExperience: ["CE", "RoHS", "FDA"], productCount: 2, cooperationYears: 5, avgLeadTime: 25, media: [{ type: "image", title: "Â∑•ÂéÇÂ§ßÈó®", url: "üè≠" }, { type: "image", title: "Ë£ÖÈÖçÁ∫ø", url: "üîß" }, { type: "video", title: "Áîü‰∫ßÊµÅÁ®ã", url: "üé¨" }], adminOnly: { legalPerson: "ÊùéÊòéÂçé", capitalCNY: 8000000, employeesRange: { min: 100, max: 200 }, contact: { person: "ÊùéÊÄª", position: "Ëë£‰∫ãÈïø", phone: "0574-6688-9999", mobile: "139-0000-6666", email: "li@zjkitchen.com" } } },
        { id: 3, name: "Âπø‰∏úÂ∞èÂÆ∂ÁîµÂà∂ÈÄ†ËÇ°‰ªΩÊúâÈôêÂÖ¨Âè∏", icon: "üè≠", rating: 4, established: 2010, location: { province: "Âπø‰∏úÁúÅ", city: "‰ΩõÂ±±Â∏Ç", district: "È°∫Âæ∑Âå∫" }, address: "Âπø‰∏úÁúÅ‰ΩõÂ±±Â∏ÇÈ°∫Âæ∑Âå∫ÂÆπÊ°ÇË°óÈÅìÂçéÂè£Â∑•‰∏öÂå∫ÊåØÂçéË∑Ø28Âè∑", mainCategories: ["Á©∫Ê∞îÁÇ∏ÈîÖ", "ÁîµÁÉ§ÁÆ±"], cooperatedBrands: ["Midea", "Galanz"], factoryCerts: ["ISO 9001", "BSCI"], productComplianceExperience: ["CE", "RoHS", "CB"], productCount: 2, cooperationYears: 4, avgLeadTime: 35, media: [{ type: "image", title: "ÂéÇÂå∫ÂÖ®ÊôØ", url: "üè≠" }, { type: "image", title: "Á†îÂèë‰∏≠ÂøÉ", url: "üí°" }], adminOnly: { legalPerson: "Âº†‰ºüÂº∫", capitalCNY: 12000000, employeesRange: { min: 200, max: 500 }, contact: { person: "Âº†ÊÄª", position: "ÊÄªÁªèÁêÜ", phone: "0757-2888-6666", mobile: "136-0000-9999", email: "zhang@gdappliance.com" } } }
      ],
      products: [
        { id: 1, sku: "VC-5000", name: "Êó†Á∫øÊâãÊåÅÂê∏Â∞òÂô® Pro", categoryId: 11, brand: "CleanPro", tags: ["ÁÉ≠ÈîÄ", "OEMÂèØÂÆöÂà∂", "CEËÆ§ËØÅ"], status: "Âú®ÂîÆ", vendorId: 1, moq: 500, factoryPrice: 22, marketGuidePrice: 25.3, priceHistory: [{ price: 22, effectiveDate: "2024-09-01", operator: "admin", reason: "‰æõÂ∫îÂïÜÈôç‰ª∑", attachments: [{ name: "Êä•‰ª∑Âçï-202409.pdf", icon: "üìÑ" }, { name: "ÂæÆ‰ø°ËÅäÂ§©ËÆ∞ÂΩï.png", icon: "üñºÔ∏è" }] }, { price: 24, effectiveDate: "2024-03-15", operator: "admin", reason: "ÂéüÊùêÊñôÊàêÊú¨‰∏äÊ∂®", expiredDate: "2024-08-31", attachments: [{ name: "Ê∂®‰ª∑ÈÄöÁü•ÂáΩ.pdf", icon: "üìÑ" }] }, { price: 20, effectiveDate: "2023-06-01", operator: "admin", reason: "ÂàùÂßãÂÆö‰ª∑", expiredDate: "2024-03-14", attachments: [] }], benchmarkProduct: "Shark Navigator NV360", benchmarkContext: "NavigatorÊòØÁæéÂõΩÂ∏ÇÂú∫ÊúÄÂèóÊ¨¢ËøéÁöÑÁ´ãÂºèÂê∏Â∞òÂô®‰πã‰∏Ä", media: [{ type: "image", title: "‰∫ßÂìÅ‰∏ªÂõæ", url: "üå™Ô∏è" }, { type: "image", title: "‰∫ßÂìÅ‰æßÈù¢", url: "üì∑" }, { type: "video", title: "‰∫ßÂìÅÊºîÁ§∫ËßÜÈ¢ë", url: "üé¨" }], datasheets: [{ name: "‰∫ßÂìÅËßÑÊ†º‰π¶", filename: "VC-5000-Spec.pdf", icon: "üìÑ" }, { name: "Áî®Êà∑ÊâãÂÜå", filename: "VC-5000-Manual.pdf", icon: "üìò" }], specs: { power: { value: 120, unit: "W" }, battery_capacity: { value: 2500, unit: "mAh" }, voltage: { value: 22, unit: "V" }, runtime: { value: 45, unit: "min" }, dust_capacity: { value: 500, unit: "ml" }, weight: { value: 1.5, unit: "kg" }, noise_level: { value: 68, unit: "dB" } }, certifications: [{ name: "CE", code: "CE-2024-001", public: true, fileIcon: "üìú" }, { name: "RoHS", code: "RoHS-2024-002", public: true, fileIcon: "üìú" }, { name: "UL", code: "UL-2024-004", public: false, fileIcon: "üìú" }], salesRestrictions: [{ country: "US", client: "Home Depot" }, { country: "EU", client: "MediaMarkt" }], internalNotes: { collaboration: [{ type: "info", icon: "üí°", title: "Â∏ÇÂú∫ÂèçÈ¶à", content: "ÂÆ¢Êà∑ÂèçÈ¶àÁîµÊ±†Áª≠Ëà™Ë°®Áé∞‰ºòÂºÇ" }], sensitive: [{ type: "warning", icon: "üîí", title: "ÊàêÊú¨Êú∫ÂØÜ", content: "Âá∫ÂéÇ‰ª∑$22.00‰∏∫Êú∫ÂØÜ‰ø°ÊÅØ" }] } },
        { id: 2, sku: "JM-2000", name: "Â§öÂäüËÉΩÁ†¥Â£ÅÊñôÁêÜÊú∫", categoryId: 2, brand: "JoyMix", tags: ["ÁÉ≠ÈîÄ", "CEËÆ§ËØÅ"], status: "Âú®ÂîÆ", vendorId: 2, moq: 300, factoryPrice: 45, marketGuidePrice: 51.75, priceHistory: [{ price: 45, effectiveDate: "2024-06-01", operator: "admin", reason: "Âπ¥Â∫¶‰ª∑Ê†ºË∞ÉÊï¥", attachments: [{ name: "2024Âπ¥Â∫¶Êä•‰ª∑Âçï.xlsx", icon: "üìä" }] }, { price: 42, effectiveDate: "2023-01-01", operator: "admin", reason: "ÂàùÂßãÂÆö‰ª∑", expiredDate: "2024-05-31", attachments: [] }], benchmarkProduct: "Vitamix E310", benchmarkContext: "E310ÊòØVitamixÂÖ•Èó®Á∫ßÁ†¥Â£ÅÊú∫", media: [{ type: "image", title: "‰∫ßÂìÅ‰∏ªÂõæ", url: "ü•§" }, { type: "image", title: "ÈÖç‰ª∂Â±ïÁ§∫", url: "üì∑" }], datasheets: [{ name: "‰∫ßÂìÅËßÑÊ†º‰π¶", filename: "JM-2000-Spec.pdf", icon: "üìÑ" }], specs: { power: { value: 1500, unit: "W" }, capacity: { value: 2000, unit: "ml" }, voltage: { value: 220, unit: "V" }, speed: { value: 30000, unit: "RPM" }, weight: { value: 3.5, unit: "kg" } }, certifications: [{ name: "CE", code: "CE-2024-011", public: true, fileIcon: "üìú" }], salesRestrictions: [], internalNotes: { collaboration: [], sensitive: [] } },
        { id: 3, sku: "AF-3500", name: "Êô∫ËÉΩÁ©∫Ê∞îÁÇ∏ÈîÖ 3.5L", categoryId: 6, brand: "AirFry Pro", tags: ["Êñ∞ÂìÅ", "Áã¨ÂÆ∂", "CEËÆ§ËØÅ"], status: "Âú®ÂîÆ", vendorId: 3, moq: 500, factoryPrice: 38, marketGuidePrice: 43.7, priceHistory: [{ price: 38, effectiveDate: "2024-01-15", operator: "admin", reason: "Êñ∞ÂìÅ‰∏äÊû∂ÂÆö‰ª∑", attachments: [] }], benchmarkProduct: "Philips HD9252", benchmarkContext: "HD9252ÊòØÈ£ûÂà©Êµ¶ÁªèÂÖ∏Ê¨æÁ©∫Ê∞îÁÇ∏ÈîÖ", media: [{ type: "image", title: "‰∫ßÂìÅ‰∏ªÂõæ", url: "üçü" }, { type: "video", title: "ÁÉπÈ•™ÊºîÁ§∫", url: "üé¨" }], datasheets: [{ name: "‰∫ßÂìÅËßÑÊ†º‰π¶", filename: "AF-3500-Spec.pdf", icon: "üìÑ" }], specs: { power: { value: 1800, unit: "W" }, capacity: { value: 3500, unit: "ml" }, voltage: { value: 220, unit: "V" }, temp_range: "80-200¬∞C", weight: { value: 4.2, unit: "kg" } }, certifications: [{ name: "CE", code: "CE-2024-021", public: true, fileIcon: "üìú" }], salesRestrictions: [{ country: "EU", client: "MediaMarkt" }], internalNotes: { collaboration: [], sensitive: [{ type: "warning", icon: "üîí", title: "Áã¨ÂÆ∂ÂçèËÆÆ", content: "MediaMarktÊúâÊ¨ßÁõüÂ∏ÇÂú∫Áã¨ÂÆ∂ÈîÄÂîÆÊùÉ" }] } },
        { id: 4, sku: "CM-800", name: "ÂÖ®Ëá™Âä®ÊÑèÂºèÂíñÂï°Êú∫", categoryId: 5, brand: "BrewMaster", tags: ["ÁÉ≠ÈîÄ", "CEËÆ§ËØÅ"], status: "Âú®ÂîÆ", vendorId: 1, moq: 200, factoryPrice: 85, marketGuidePrice: 97.75, priceHistory: [{ price: 85, effectiveDate: "2024-01-01", operator: "admin", reason: "ÂàùÂßãÂÆö‰ª∑" }], benchmarkProduct: "DeLonghi Magnifica", benchmarkContext: "MagnificaÊòØÂæ∑ÈæôÂÖ•Èó®Á∫ßÂÖ®Ëá™Âä®ÂíñÂï°Êú∫", media: [{ type: "image", url: "‚òï" }], specs: { power: { value: 1200, unit: "W" }, capacity: { value: 800, unit: "ml" }, voltage: { value: 220, unit: "V" }, weight: { value: 2.8, unit: "kg" } }, certifications: [{ name: "CE", code: "CE-2024-031", public: true }], salesRestrictions: [], internalNotes: { collaboration: [], sensitive: [] } },
        { id: 5, sku: "SM-1200", name: "Êô∫ËÉΩËí∏Ê±ΩÊãñÊää", categoryId: 13, brand: "SteamClean", tags: ["Êñ∞ÂìÅ", "ÁéØ‰øù", "CEËÆ§ËØÅ"], status: "Âú®ÂîÆ", vendorId: 1, moq: 400, factoryPrice: 32, marketGuidePrice: 36.8, priceHistory: [{ price: 32, effectiveDate: "2024-02-01", operator: "admin", reason: "ÂàùÂßãÂÆö‰ª∑" }], benchmarkProduct: "Shark Steam Mop", benchmarkContext: "Shark Steam MopÊòØÁæéÂõΩÂ∏ÇÂú∫ÁÉ≠ÈîÄÁöÑËí∏Ê±ΩÊãñÊää", media: [{ type: "image", url: "üßπ" }], specs: { power: { value: 1500, unit: "W" }, weight: { value: 2.5, unit: "kg" } }, certifications: [{ name: "CE", code: "CE-2024-041", public: true }], salesRestrictions: [], internalNotes: { collaboration: [], sensitive: [] } },
        { id: 6, sku: "RV-2000", name: "Êô∫ËÉΩÊâ´Âú∞Êú∫Âô®‰∫∫", categoryId: 12, brand: "RoboVac", tags: ["ÁÉ≠ÈîÄ", "ÈùôÈü≥", "CEËÆ§ËØÅ"], status: "Âú®ÂîÆ", vendorId: 1, moq: 300, factoryPrice: 120, marketGuidePrice: 138, priceHistory: [{ price: 120, effectiveDate: "2024-04-01", operator: "admin", reason: "ÂàùÂßãÂÆö‰ª∑" }], benchmarkProduct: "iRobot Roomba 694", benchmarkContext: "Roomba 694ÊòØiRobotÂÖ•Èó®Á∫ßÊâ´Âú∞Êú∫Âô®‰∫∫", media: [{ type: "image", url: "ü§ñ" }], specs: { power: { value: 25, unit: "W" }, battery_capacity: { value: 2600, unit: "mAh" }, voltage: { value: 14.4, unit: "V" }, runtime: { value: 90, unit: "min" }, dust_capacity: { value: 600, unit: "ml" }, weight: { value: 2.8, unit: "kg" }, noise_level: { value: 55, unit: "dB" } }, certifications: [{ name: "CE", code: "CE-2024-051", public: true }], salesRestrictions: [], internalNotes: { collaboration: [], sensitive: [] } },
        { id: 7, sku: "BM-500", name: "‰æøÊê∫ÂºèÊ¶®Ê±ÅÊùØ", categoryId: 2, brand: "BlendMini", tags: ["Êñ∞ÂìÅ", "CEËÆ§ËØÅ"], status: "Âú®ÂîÆ", vendorId: 2, moq: 500, factoryPrice: 12, marketGuidePrice: 13.8, priceHistory: [{ price: 12, effectiveDate: "2024-05-01", operator: "admin", reason: "ÂàùÂßãÂÆö‰ª∑" }], benchmarkProduct: "BlendJet 2", benchmarkContext: "BlendJet 2ÊòØÁæéÂõΩÁÉ≠ÈîÄÁöÑ‰æøÊê∫ÂºèÊ¶®Ê±ÅÊùØ", media: [{ type: "image", url: "ü•§" }], specs: { power: { value: 60, unit: "W" }, capacity: { value: 500, unit: "ml" }, voltage: { value: 7.4, unit: "V" }, speed: { value: 20000, unit: "RPM" }, weight: { value: 0.5, unit: "kg" } }, certifications: [{ name: "CE", code: "CE-2024-061", public: true }], salesRestrictions: [], internalNotes: { collaboration: [], sensitive: [] } },
        { id: 8, sku: "FC-800", name: "Â∏ÉËâ∫Ê∏ÖÊ¥óÊú∫", categoryId: 14, brand: "FabricCare", tags: ["Êñ∞ÂìÅ", "CEËÆ§ËØÅ"], status: "Âú®ÂîÆ", vendorId: 3, moq: 300, factoryPrice: 55, marketGuidePrice: 63.25, priceHistory: [{ price: 55, effectiveDate: "2024-03-01", operator: "admin", reason: "ÂàùÂßãÂÆö‰ª∑" }], benchmarkProduct: "Bissell SpotClean", benchmarkContext: "Bissell SpotCleanÊòØÁæéÂõΩÂ∏ÇÂú∫ÁÉ≠ÈîÄÁöÑÂ∏ÉËâ∫Ê∏ÖÊ¥óÊú∫", media: [{ type: "image", url: "üßΩ" }], specs: { power: { value: 500, unit: "W" }, weight: { value: 4.5, unit: "kg" } }, certifications: [{ name: "CE", code: "CE-2024-071", public: true }], salesRestrictions: [], internalNotes: { collaboration: [], sensitive: [] } }
      ]
    };

    const state = { currentUser: null, currentRole: null, isClientMode: false, selectedProductIds: [], lastNonClientHash: "", sidebarOpen: false, filters: { search: "", categoryId: "" }, editingItem: null, editingType: null, editingParams: [], editingVendorMedia: [], editingProductMedia: [], editingProductDatasheets: [], editingProductCerts: [], editingPriceAttachments: [] };

    function getCategoryById(id) { return db.categories.find(c => c.id === id); }
    function getVendorById(id) { return db.vendors.find(v => v.id === parseInt(id)); }
    function getProductById(id) { return db.products.find(p => p.id === parseInt(id)); }
    function getTagByName(name) { return db.tags.find(t => t.name === name); }
    function getTemplateByKey(key) { return db.templates.find(t => t.templateKey === key); }
    function getUserById(id) { return db.users.find(u => u.id === parseInt(id)); }
    function getNextId(arr) { return arr.length === 0 ? 1 : Math.max(...arr.map(i => i.id)) + 1; }
    function formatPrice(p) { return "$" + p.toFixed(2); }
    function formatMoney(n) { return "¬•" + (n / 10000).toFixed(0) + "‰∏á"; }
    function getTagColor(name) { var t = getTagByName(name); return t ? { color: t.color, bgColor: t.bgColor } : { color: "#8C8C8C", bgColor: "#FAFAFA" }; }
    function showToast(msg, type) { var t = document.getElementById("toast"); t.textContent = msg; t.className = "toast show toast-" + (type || "success"); setTimeout(function() { t.classList.remove("show"); }, 3000); }

    function getRecentPriceChanges() {
      var changes = [];
      db.products.forEach(function(product) {
        if (product.priceHistory && product.priceHistory.length > 0) {
          product.priceHistory.forEach(function(h, idx) {
            var prevPrice = idx < product.priceHistory.length - 1 ? product.priceHistory[idx + 1].price : null;
            changes.push({
              productId: product.id,
              productName: product.name,
              sku: product.sku,
              newPrice: h.price,
              oldPrice: prevPrice,
              effectiveDate: h.effectiveDate,
              operator: h.operator,
              reason: h.reason,
              attachments: h.attachments || []
            });
          });
        }
      });
      changes.sort(function(a, b) { return new Date(b.effectiveDate) - new Date(a.effectiveDate); });
      return changes.slice(0, 5);
    }

    function togglePriceNotification() {
      // ‰øùÁïôÂáΩÊï∞‰ΩÜ‰∏çÂÜçÈúÄË¶Å
    }

    function renderPriceNotifications() {
      if (state.currentRole !== "admin") {
        document.getElementById("priceNotificationBubble").style.display = "none";
        return;
      }
      document.getElementById("priceNotificationBubble").style.display = "block";
      var changes = getRecentPriceChanges();
      var html = "";
      if (changes.length === 0) {
        html = '<div style="padding: 16px; text-align: center; color: #8C8C8C; font-size: 12px;">ÊöÇÊó†‰ª∑Ê†ºÂèòÊõ¥ËÆ∞ÂΩï</div>';
      } else {
        changes.forEach(function(c) {
          var priceChange = c.oldPrice ? (c.newPrice > c.oldPrice ? '‚Üë' : (c.newPrice < c.oldPrice ? '‚Üì' : '‚Üí')) : 'üÜï';
          html += '<div class="price-notification-item" onclick="navigate(\'#/product/' + c.productId + '\')">';
          html += '<div class="price-notification-item-header"><span class="price-notification-item-product" title="' + c.productName + '">' + c.productName + '</span><span class="price-notification-item-date">' + c.effectiveDate + '</span></div>';
          html += '<div class="price-notification-item-price">';
          if (c.oldPrice) html += '<span class="price-notification-item-old">' + formatPrice(c.oldPrice) + '</span><span class="price-notification-item-arrow">' + priceChange + '</span>';
          html += '<span class="price-notification-item-new">' + formatPrice(c.newPrice) + '</span></div>';
          html += '<div class="price-notification-item-reason" title="' + c.reason + '">' + c.reason + '</div>';
          html += '</div>';
        });
      }
      document.getElementById("priceNotificationList").innerHTML = html;
    }

    function filterByRole(item, type) {
      var effectiveRole = state.isClientMode ? "client" : state.currentRole;
      if (type === "product") {
        var p = JSON.parse(JSON.stringify(item));
        if (effectiveRole === "sales") { delete p.vendorId; delete p.factoryPrice; delete p.moq; p.internalNotes = { collaboration: p.internalNotes ? p.internalNotes.collaboration || [] : [], sensitive: [] }; }
        else if (effectiveRole === "client") { delete p.vendorId; delete p.factoryPrice; delete p.marketGuidePrice; delete p.moq; delete p.benchmarkProduct; delete p.benchmarkContext; delete p.salesRestrictions; delete p.internalNotes; p.tags = p.tags.filter(function(t) { var tag = getTagByName(t); return tag && tag.visibleTo.indexOf("client") !== -1; }); if (p.certifications) p.certifications = p.certifications.filter(function(c) { return c.public; }); }
        return p;
      }
      if (type === "vendor" && effectiveRole !== "admin") return null;
      return item;
    }

    function matchRoute(hash, pattern) { var h = hash.replace(/^#\//, "").split("/"); var p = pattern.replace(/^#\//, "").split("/"); return h.length === p.length && p.every(function(s, i) { return s.charAt(0) === ":" || s === h[i]; }); }
    function extractParams(hash, pattern) { var h = hash.replace(/^#\//, "").split("/"); var p = pattern.replace(/^#\//, "").split("/"); var params = {}; p.forEach(function(s, i) { if (s.charAt(0) === ":") params[s.slice(1)] = h[i]; }); return params; }

    var permissionRules = [
      { pattern: "#/login", roles: ["*"], requireClientMode: null },
      { pattern: "#/products", roles: ["admin"], requireClientMode: false },
      { pattern: "#/product/:id", roles: ["admin"], requireClientMode: false },
      { pattern: "#/product-edit/:id", roles: ["admin"], requireClientMode: false },
      { pattern: "#/product-edit", roles: ["admin"], requireClientMode: false },
      { pattern: "#/compare", roles: ["admin"], requireClientMode: false },
      { pattern: "#/vendors", roles: ["admin"], requireClientMode: false },
      { pattern: "#/vendor/:id", roles: ["admin"], requireClientMode: false },
      { pattern: "#/vendor-edit/:id", roles: ["admin"], requireClientMode: false },
      { pattern: "#/vendor-edit", roles: ["admin"], requireClientMode: false },
      { pattern: "#/settings/:key", roles: ["admin"], requireClientMode: false },
      { pattern: "#/sales/products", roles: ["sales", "admin"], requireClientMode: false },
      { pattern: "#/sales/product/:id", roles: ["sales", "admin"], requireClientMode: false },
      { pattern: "#/sales/compare", roles: ["sales", "admin"], requireClientMode: false },
      { pattern: "#/client/products", roles: ["*"], requireClientMode: true },
      { pattern: "#/client/product/:id", roles: ["*"], requireClientMode: true },
      { pattern: "#/client/compare", roles: ["*"], requireClientMode: true }
    ];

    function guardRoute(hash) {
      var currentRole = state.currentRole, isClientMode = state.isClientMode;
      if (!currentRole) return hash === "#/login" ? hash : "#/login";
      if (hash === "#/login") return currentRole === "sales" ? "#/sales/products" : "#/products";
      var rule = null;
      for (var i = 0; i < permissionRules.length; i++) { if (matchRoute(hash, permissionRules[i].pattern)) { rule = permissionRules[i]; break; } }
      if (!rule) return currentRole === "sales" ? "#/sales/products" : "#/products";
      if (rule.requireClientMode === true && !isClientMode) return currentRole === "sales" ? "#/sales/products" : "#/products";
      if (rule.requireClientMode === false && isClientMode) return "#/client/products";
      if (rule.roles[0] !== "*" && rule.roles.indexOf(currentRole) === -1) return "#/sales/products";
      return hash;
    }

    function navigate(hash) { window.location.hash = guardRoute(hash); }

    function router() {
      var hash = window.location.hash || "#/login";
      var target = guardRoute(hash);
      if (target !== hash) { window.location.hash = target; return; }
      var params = {};
      for (var i = 0; i < permissionRules.length; i++) { if (matchRoute(hash, permissionRules[i].pattern)) { params = extractParams(hash, permissionRules[i].pattern); break; } }
      if (hash === "#/login") renderLogin();
      else if (hash === "#/products" || hash === "#/sales/products" || hash === "#/client/products") renderProductList();
      else if (matchRoute(hash, "#/product/:id") || matchRoute(hash, "#/sales/product/:id") || matchRoute(hash, "#/client/product/:id")) renderProductDetail(params.id);
      else if (matchRoute(hash, "#/product-edit/:id") || hash === "#/product-edit") renderProductEdit(params.id);
      else if (hash === "#/compare" || hash === "#/sales/compare" || hash === "#/client/compare") renderProductCompare();
      else if (hash === "#/vendors") renderVendorList();
      else if (matchRoute(hash, "#/vendor/:id")) renderVendorDetail(params.id);
      else if (matchRoute(hash, "#/vendor-edit/:id") || hash === "#/vendor-edit") renderVendorEdit(params.id);
      else if (matchRoute(hash, "#/settings/:key")) renderSettings(params.key);
      else render404();
      renderPriceNotifications();
    }

    function login(username, password) { var user = db.users.find(function(u) { return u.username === username && u.demoPassword === password; }); if (user) { state.currentUser = user; state.currentRole = user.role; navigate(user.role === "sales" ? "#/sales/products" : "#/products"); } else { return "Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ"; } }
    function logout() { state.currentUser = null; state.currentRole = null; state.isClientMode = false; state.selectedProductIds = []; state.lastNonClientHash = ""; navigate("#/login"); }
    function enableClientMode() { var hash = window.location.hash || "#/login"; state.lastNonClientHash = hash; state.isClientMode = true; if (hash.indexOf("#/sales/product/") === 0) navigate(hash.replace("#/sales/product/", "#/client/product/")); else if (hash.indexOf("#/product/") === 0 && hash.indexOf("-edit") === -1) navigate(hash.replace("#/product/", "#/client/product/")); else if (hash === "#/sales/products" || hash === "#/products") navigate("#/client/products"); else if (hash === "#/sales/compare" || hash === "#/compare") navigate("#/client/compare"); else navigate("#/client/products"); }
    function disableClientMode() { document.getElementById("clientModeModal").classList.add("active"); }
    function cancelClientModeClose() { document.getElementById("clientModeModal").classList.remove("active"); document.getElementById("clientModePassword").value = ""; document.getElementById("clientModeError").style.display = "none"; }
    function confirmClientModeClose() { var pwd = document.getElementById("clientModePassword").value; if (pwd === state.currentUser.demoPassword) { state.isClientMode = false; document.getElementById("clientModeModal").classList.remove("active"); document.getElementById("clientModePassword").value = ""; document.getElementById("clientModeError").style.display = "none"; navigate(state.lastNonClientHash || (state.currentRole === "sales" ? "#/sales/products" : "#/products")); } else { document.getElementById("clientModeError").style.display = "block"; } }
    function toggleClientMode() { state.isClientMode ? disableClientMode() : enableClientMode(); }
    function toggleSidebar() { state.sidebarOpen = !state.sidebarOpen; var sidebar = document.querySelector(".sidebar"); if (sidebar) sidebar.classList.toggle("active", state.sidebarOpen); }

    function getSidebarMenus() {
      var currentRole = state.currentRole, isClientMode = state.isClientMode;
      if (isClientMode) return [{ section: "‰∫ßÂìÅÁÆ°ÁêÜ", items: [{ icon: "üì¶", label: "‰∫ßÂìÅÂàóË°®", hash: "#/client/products" }, { icon: "‚öñÔ∏è", label: "‰∫ßÂìÅÂØπÊØî", hash: "#/client/compare" }] }];
      if (currentRole === "admin") return [{ section: "‰∫ßÂìÅÁÆ°ÁêÜ", items: [{ icon: "üì¶", label: "‰∫ßÂìÅÂàóË°®", hash: "#/products" }, { icon: "‚öñÔ∏è", label: "‰∫ßÂìÅÂØπÊØî", hash: "#/compare" }] }, { section: "‰æõÂ∫îÂïÜÁÆ°ÁêÜ", items: [{ icon: "üè≠", label: "‰æõÂ∫îÂïÜÂàóË°®", hash: "#/vendors" }] }, { section: "Á≥ªÁªüËÆæÁΩÆ", items: [{ icon: "üìÅ", label: "ÂàÜÁ±ªÁÆ°ÁêÜ", hash: "#/settings/categories" }, { icon: "üè∑Ô∏è", label: "Ê†áÁ≠æÁÆ°ÁêÜ", hash: "#/settings/tags" }, { icon: "üìã", label: "ÂèÇÊï∞Ê®°Êùø", hash: "#/settings/templates" }, { icon: "üë•", label: "Áî®Êà∑ÁÆ°ÁêÜ", hash: "#/settings/users" }] }];
      if (currentRole === "sales") return [{ section: "‰∫ßÂìÅÁÆ°ÁêÜ", items: [{ icon: "üì¶", label: "‰∫ßÂìÅÂàóË°®", hash: "#/sales/products" }, { icon: "‚öñÔ∏è", label: "‰∫ßÂìÅÂØπÊØî", hash: "#/sales/compare" }] }];
      return [];
    }

    function renderTopbar() {
      if (!state.currentUser) return "";
      var currentUser = state.currentUser, isClientMode = state.isClientMode;
      var logoHash = currentUser.role === "sales" ? "#/sales/products" : "#/products";
      var html = '<div class="topbar' + (isClientMode ? " client-mode-active" : "") + '">';
      html += '<div class="topbar-left">';
      html += '<div class="topbar-menu-toggle" onclick="toggleSidebar()">‚ò∞</div>';
      html += '<div class="topbar-logo" onclick="navigate(\'' + logoHash + '\')">SMS</div>';
      if (isClientMode) html += '<div class="topbar-client-badge">üëÅ ÂÆ¢Êà∑ÊºîÁ§∫Ê®°Âºè</div>';
      html += '</div>';
      html += '<div class="topbar-right">';
      html += '<button class="topbar-client-mode' + (isClientMode ? " active" : "") + '" onclick="toggleClientMode()">' + (isClientMode ? "üîí ÈÄÄÂá∫ÊºîÁ§∫Ê®°Âºè" : "üëÅ ÂÆ¢Êà∑ÊºîÁ§∫Ê®°Âºè") + '</button>';
      html += '<div class="topbar-user"><div class="topbar-avatar" style="background: ' + currentUser.avatarBg + '">' + currentUser.avatar + '</div><div><div class="topbar-username">' + currentUser.realName + '</div><div class="topbar-role">' + (currentUser.role === "admin" ? "ÁÆ°ÁêÜÂëò" : "‰∏öÂä°Âëò") + '</div></div></div>';
      html += '<button class="topbar-logout" onclick="logout()">ÈÄÄÂá∫</button>';
      html += '</div></div>';
      return html;
    }

    function renderSidebar() {
      if (!state.currentUser) return "";
      var menus = getSidebarMenus();
      var hash = window.location.hash;
      var html = '<div class="sidebar' + (state.sidebarOpen ? " active" : "") + '">';
      menus.forEach(function(m) {
        html += '<div class="sidebar-section"><div class="sidebar-section-title">' + m.section + '</div>';
        m.items.forEach(function(i) {
          html += '<div class="sidebar-menu-item' + (hash === i.hash ? " active" : "") + '" onclick="navigate(\'' + i.hash + '\'); state.sidebarOpen = false; router();"><span>' + i.icon + '</span><span>' + i.label + '</span></div>';
        });
        html += '</div>';
      });
      html += '</div>';
      return html;
    }

    function renderLayout(content) { var app = document.getElementById("app"); var loggedIn = !!state.currentUser; app.innerHTML = (loggedIn ? renderTopbar() : "") + (loggedIn ? renderSidebar() : "") + '<div class="main-content' + (loggedIn ? "" : " no-sidebar full-width") + '">' + content + '</div>'; }

    function renderLogin() {
      document.getElementById("app").innerHTML = '<div class="login-container"><div class="login-brand"><div class="login-brand-logo">SMS</div><div class="login-brand-title">Â§ñË¥∏Â∞èÂÆ∂Áîµ‰æõÂ∫îÂïÜÁÆ°ÁêÜÁ≥ªÁªü</div><div class="login-brand-subtitle">Supplier Management System</div></div><div class="login-form-section"><div class="login-form-wrapper"><div class="login-form-title">Ê¨¢ËøéÁôªÂΩï</div><form onsubmit="event.preventDefault(); handleLogin();"><div class="form-group"><label class="form-label">Áî®Êà∑Âêç</label><input type="text" id="loginUsername" class="form-input" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" required></div><div class="form-group"><label class="form-label">ÂØÜÁ†Å</label><input type="password" id="loginPassword" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" required><div id="loginError" class="form-error" style="display: none;"></div></div><button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">ÁôªÂΩï</button></form><div class="login-test-accounts"><div class="login-test-accounts-title">ÊµãËØïË¥¶Âè∑</div><div class="login-test-account"><span>ÁÆ°ÁêÜÂëò: admin</span><span>ÂØÜÁ†Å: 123456</span></div><div class="login-test-account"><span>‰∏öÂä°Âëò: sales</span><span>ÂØÜÁ†Å: 123456</span></div></div></div></div></div>';
    }

    function handleLogin() { var u = document.getElementById("loginUsername").value; var p = document.getElementById("loginPassword").value; var err = login(u, p); if (err) { var errEl = document.getElementById("loginError"); errEl.textContent = err; errEl.style.display = "block"; } }

    function renderProductList() {
      var hash = window.location.hash;
      var mode = "admin";
      if (hash.indexOf("#/sales/") === 0) mode = "sales";
      if (hash.indexOf("#/client/") === 0) mode = "client";
      var products = db.products.map(function(p) { return filterByRole(p, "product"); });
      if (state.filters.search) { var s = state.filters.search.toLowerCase(); products = products.filter(function(p) { return p.name.toLowerCase().indexOf(s) !== -1 || p.sku.toLowerCase().indexOf(s) !== -1; }); }
      if (state.filters.categoryId) products = products.filter(function(p) { return p.categoryId === parseInt(state.filters.categoryId); });

      var comparePath = mode === "client" ? "#/client/compare" : mode === "sales" ? "#/sales/compare" : "#/compare";

      var html = '<div class="filter-bar"><div class="filter-row"><div class="filter-item flex-1"><label class="form-label">ÊêúÁ¥¢</label><input type="text" class="form-input" placeholder="‰∫ßÂìÅÂêçÁß∞ÊàñSKU" value="' + state.filters.search + '" oninput="state.filters.search = this.value; router();"></div><div class="filter-item"><label class="form-label">ÂàÜÁ±ª</label><select class="form-select" onchange="state.filters.categoryId = this.value; router();"><option value="">ÂÖ®ÈÉ®ÂàÜÁ±ª</option>';
      db.categories.filter(function(c) { return c.parentId !== null; }).forEach(function(c) { html += '<option value="' + c.id + '"' + (state.filters.categoryId == c.id ? " selected" : "") + '>' + c.name + '</option>'; });
      html += '</select></div><div class="filter-item" style="display: flex; align-items: flex-end;"><button class="btn btn-default" onclick="state.filters = { search: \'\', categoryId: \'\' }; router();">ÈáçÁΩÆ</button></div></div></div>';

      html += '<div class="card"><div class="card-header"><div><div class="card-title">‰∫ßÂìÅÂàóË°®</div><div class="card-subtitle">ÂÖ± ' + products.length + ' ‰∏™‰∫ßÂìÅ' + (state.selectedProductIds.length > 0 ? 'ÔºåÂ∑≤ÈÄâ ' + state.selectedProductIds.length + ' ‰∏™' : '') + '</div></div><div class="card-actions">';
      if (mode === "admin") html += '<button class="btn btn-primary" onclick="navigate(\'#/product-edit\')">‚ûï Êñ∞Â¢û‰∫ßÂìÅ</button>';
      html += '<button class="btn btn-default"' + (state.selectedProductIds.length < 2 || state.selectedProductIds.length > 8 ? " disabled" : "") + ' onclick="navigate(\'' + comparePath + '\')">‚öñÔ∏è ÂºÄÂßãÂØπÊØî (' + state.selectedProductIds.length + ')</button>';
      if (state.selectedProductIds.length > 0) html += '<button class="btn btn-default" onclick="state.selectedProductIds = []; router();">Ê∏ÖÁ©∫ÈÄâÊã©</button>';
      html += '</div></div></div>';

      html += '<div class="grid grid-3">';
      products.forEach(function(p) {
        var selected = state.selectedProductIds.indexOf(p.id) !== -1;
        var detailPath = hash.indexOf("client") !== -1 ? "#/client/product/" : hash.indexOf("sales") !== -1 ? "#/sales/product/" : "#/product/";
        html += '<div class="product-card' + (selected ? ' product-card-selected' : '') + '">';
        html += '<input type="checkbox" class="product-card-checkbox"' + (selected ? " checked" : "") + ' onchange="toggleProductSelection(' + p.id + ')" onclick="event.stopPropagation();">';
        html += '<div class="product-card-image" onclick="navigate(\'' + detailPath + p.id + '\')">' + (p.media && p.media[0] ? p.media[0].url : "üì¶") + '</div>';
        html += '<div class="product-card-body" onclick="navigate(\'' + detailPath + p.id + '\')">';
        html += '<div class="product-card-name">' + p.name + '</div><div class="product-card-sku">SKU: ' + p.sku + '</div><div class="product-card-tags">';
        (p.tags || []).forEach(function(t) { var c = getTagColor(t); html += '<span class="tag" style="background: ' + c.bgColor + '; color: ' + c.color + '">' + t + '</span>'; });
        html += '</div>';
        if (mode !== "client" && p.marketGuidePrice) html += '<div class="product-card-price"><span class="product-card-price-label">ÊåáÂØº‰ª∑</span><span class="product-card-price-value">' + formatPrice(p.marketGuidePrice) + '</span></div>';
        if (mode === "admin" && p.factoryPrice) html += '<div class="product-card-price"><span class="product-card-price-label">Âá∫ÂéÇ‰ª∑ üîí</span><span class="product-card-price-value" style="color: #FF4D4F;">' + formatPrice(p.factoryPrice) + '</span></div>';
        html += '</div></div>';
      });
      html += '</div>';
      renderLayout(html);
    }

    function toggleProductSelection(id) { var idx = state.selectedProductIds.indexOf(id); if (idx > -1) state.selectedProductIds.splice(idx, 1); else if (state.selectedProductIds.length < 8) state.selectedProductIds.push(id); router(); }

    function renderProductDetail(id) {
      var product = getProductById(id);
      if (!product) return render404();
      var p = filterByRole(product, "product");
      var cat = getCategoryById(p.categoryId);
      var vendor = p.vendorId ? getVendorById(p.vendorId) : null;
      var template = cat && cat.templateKey ? getTemplateByKey(cat.templateKey) : null;
      var hash = window.location.hash;
      var mode = "admin", backPath = "#/products";
      if (hash.indexOf("#/sales/") === 0) { mode = "sales"; backPath = "#/sales/products"; }
      if (hash.indexOf("#/client/") === 0) { mode = "client"; backPath = "#/client/products"; }

      var images = p.media ? p.media.filter(function(m) { return m.type === 'image'; }) : [];
      var videos = p.media ? p.media.filter(function(m) { return m.type === 'video'; }) : [];
      var isInCompare = state.selectedProductIds.indexOf(p.id) !== -1;
      var comparePath = mode === "client" ? "#/client/compare" : mode === "sales" ? "#/sales/compare" : "#/compare";

      var html = '<div class="card"><div class="card-header"><div><div class="card-title">' + p.name + '</div><div class="card-subtitle">SKU: ' + p.sku + '</div></div><div class="card-actions">';
      html += '<button class="btn btn-default" onclick="navigate(\'' + backPath + '\')">‚Üê ËøîÂõûÂàóË°®</button>';
      if (mode === "admin") html += '<button class="btn btn-primary" onclick="navigate(\'#/product-edit/' + id + '\')">‚úèÔ∏è ÁºñËæë</button>';
      html += '<button class="btn ' + (isInCompare ? 'btn-danger' : 'btn-default') + '" onclick="toggleProductSelection(' + p.id + '); router();">' + (isInCompare ? '‚úì Â∑≤Âä†ÂÖ•ÂØπÊØî' : '‚öñÔ∏è Âä†ÂÖ•ÂØπÊØî') + '</button>';
      if (state.selectedProductIds.length >= 2) html += '<button class="btn btn-primary" onclick="navigate(\'' + comparePath + '\')">Êü•ÁúãÂØπÊØî (' + state.selectedProductIds.length + ')</button>';
      html += '</div></div>';
      if (state.selectedProductIds.length > 0) {
        html += '<div style="padding: 12px 24px; background: #E6F7FF; border-bottom: 1px solid #91D5FF;"><span style="color: #1890FF;">üìã Â∑≤ÈÄâÊã© ' + state.selectedProductIds.length + ' ‰∏™‰∫ßÂìÅÂØπÊØîÔºö</span>';
        state.selectedProductIds.forEach(function(pid) { var sp = getProductById(pid); if (sp) html += '<span class="tag tag-blue" style="margin-left: 8px;">' + sp.name + ' <a onclick="toggleProductSelection(' + pid + '); router();" style="cursor: pointer; margin-left: 4px;">√ó</a></span>'; });
        html += '</div>';
      }
      html += '<div class="card-body"><div style="display: grid; grid-template-columns: 400px 1fr; gap: 32px;"><div>';
      html += '<div class="media-main">' + (images.length > 0 ? images[0].url : "üì¶") + '</div>';
      if (images.length > 1) {
        html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 12px;">';
        images.forEach(function(img, idx) { html += '<div style="background: #F5F6FA; border-radius: 8px; padding: 12px; text-align: center; cursor: pointer;' + (idx === 0 ? ' border: 2px solid #1890FF;' : '') + '"><div style="font-size: 32px;">' + img.url + '</div><div style="font-size: 11px; color: #8C8C8C; margin-top: 4px;">' + (img.title || 'ÂõæÁâá') + '</div></div>'; });
        html += '</div>';
      }
      if (videos.length > 0) {
        html += '<div style="margin-top: 16px;"><div style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">üé¨ ‰∫ßÂìÅËßÜÈ¢ë (' + videos.length + ')</div>';
        videos.forEach(function(v) { html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; padding: 16px; text-align: center; color: #fff; margin-bottom: 8px;"><div style="font-size: 32px;">' + v.url + '</div><div style="font-size: 13px; margin-top: 4px;">' + (v.title || 'ËßÜÈ¢ë') + '</div><button class="btn btn-sm" style="margin-top: 8px; background: rgba(255,255,255,0.2); border: 1px solid #fff; color: #fff;">‚ñ∂ Êí≠Êîæ</button></div>'; });
        html += '</div>';
      }
      html += '</div><div>';
      html += '<div class="info-grid"><div class="info-item"><div class="info-label">ÂìÅÁâå</div><div class="info-value">' + p.brand + '</div></div><div class="info-item"><div class="info-label">ÂàÜÁ±ª</div><div class="info-value">' + (cat ? cat.name : "-") + '</div></div><div class="info-item"><div class="info-label">Áä∂ÊÄÅ</div><div class="info-value">' + p.status + '</div></div>';
      if (mode === "admin" && vendor) html += '<div class="info-item"><div class="info-label">‰æõÂ∫îÂïÜ</div><div class="info-value"><a onclick="navigate(\'#/vendor/' + vendor.id + '\')" style="cursor:pointer">' + vendor.name + '</a></div></div>';
      html += '</div>';
      if (p.tags && p.tags.length) { html += '<div style="margin: 16px 0;">'; p.tags.forEach(function(t) { var c = getTagColor(t); html += '<span class="tag" style="background: ' + c.bgColor + '; color: ' + c.color + '">' + t + '</span> '; }); html += '</div>'; }
      if (mode !== "client" && (p.marketGuidePrice || p.factoryPrice)) {
        html += '<div class="section"><div class="section-title">‰ª∑Ê†º‰ø°ÊÅØ</div>';
        if (p.marketGuidePrice) html += '<div class="alert alert-info"><div style="font-weight: bold;">Â∏ÇÂú∫ÊåáÂØº‰ª∑</div><div style="font-size: 24px; color: #1890FF; font-weight: bold; margin-top: 8px;">' + formatPrice(p.marketGuidePrice) + '</div></div>';
        if (mode === "admin" && p.factoryPrice) html += '<div class="alert alert-error"><div style="font-weight: bold;">üîí Âá∫ÂéÇ‰ª∑(Êú∫ÂØÜ)</div><div style="font-size: 24px; color: #FF4D4F; font-weight: bold; margin-top: 8px;">' + formatPrice(p.factoryPrice) + '</div><div style="font-size: 12px; color: #8C8C8C; margin-top: 4px;">MOQ: ' + p.moq + ' pcs</div></div>';
        html += '</div>';
      }
      if (mode === "admin" && p.priceHistory && p.priceHistory.length > 0) {
        html += '<div class="section"><div class="section-title">üìä Âá∫ÂéÇ‰ª∑ÂèòÊõ¥ÂéÜÂè≤ <span style="font-size: 12px; font-weight: normal; color: #8C8C8C;">(' + p.priceHistory.length + 'Êù°ËÆ∞ÂΩï)</span></div>';
        html += '<div style="background: #FFFBE6; border: 1px solid #FFE58F; border-radius: 8px; overflow: hidden;">';
        html += '<table style="width: 100%; border-collapse: collapse; font-size: 13px;"><thead><tr style="background: #FFF7E6;"><th style="padding: 10px; text-align: left; border-bottom: 1px solid #FFE58F;">‰ª∑Ê†º</th><th style="padding: 10px; text-align: left; border-bottom: 1px solid #FFE58F;">ÁîüÊïàÊó•Êúü</th><th style="padding: 10px; text-align: left; border-bottom: 1px solid #FFE58F;">Â§±ÊïàÊó•Êúü</th><th style="padding: 10px; text-align: left; border-bottom: 1px solid #FFE58F;">Êìç‰Ωú‰∫∫</th><th style="padding: 10px; text-align: left; border-bottom: 1px solid #FFE58F;">ÂèòÊõ¥ÂéüÂõ†</th><th style="padding: 10px; text-align: left; border-bottom: 1px solid #FFE58F;">ÈôÑ‰ª∂Âá≠ËØÅ</th></tr></thead><tbody>';
        p.priceHistory.forEach(function(h, idx) {
          var isActive = idx === 0 && !h.expiredDate;
          var attachHtml = '';
          if (h.attachments && h.attachments.length > 0) {
            h.attachments.forEach(function(att) { attachHtml += '<span class="price-attachment">' + (att.icon || 'üìé') + ' ' + att.name + '</span>'; });
          } else {
            attachHtml = '<span style="color: #8C8C8C;">-</span>';
          }
          html += '<tr style="' + (isActive ? 'background: #F6FFED;' : '') + '"><td style="padding: 10px; border-bottom: 1px solid #FFE58F;"><strong style="color: ' + (isActive ? '#52C41A' : '#8C8C8C') + ';">' + formatPrice(h.price) + '</strong>' + (isActive ? ' <span class="tag tag-green" style="font-size: 10px;">ÂΩìÂâçÁîüÊïà</span>' : ' <span class="tag tag-gray" style="font-size: 10px;">Â∑≤Â§±Êïà</span>') + '</td><td style="padding: 10px; border-bottom: 1px solid #FFE58F;">' + h.effectiveDate + '</td><td style="padding: 10px; border-bottom: 1px solid #FFE58F; color: ' + (h.expiredDate ? '#FF4D4F' : '#52C41A') + ';">' + (h.expiredDate || 'Ëá≥‰ªäÊúâÊïà') + '</td><td style="padding: 10px; border-bottom: 1px solid #FFE58F;">' + h.operator + '</td><td style="padding: 10px; border-bottom: 1px solid #FFE58F;">' + h.reason + '</td><td style="padding: 10px; border-bottom: 1px solid #FFE58F;">' + attachHtml + '</td></tr>';
        });
        html += '</tbody></table></div></div>';
      }
      if (mode !== "client" && p.benchmarkProduct) html += '<div class="section"><div class="section-title">üéØ Á´ûÂìÅÂØπÊ†á</div><div class="alert alert-info"><div style="font-weight: bold;">ÂØπÊ†á‰∫ßÂìÅ: ' + p.benchmarkProduct + '</div>' + (p.benchmarkContext ? '<div style="margin-top: 8px;">' + p.benchmarkContext + '</div>' : "") + '</div></div>';
      if (mode === "admin" && p.salesRestrictions && p.salesRestrictions.length) { html += '<div class="section"><div class="section-title">üö´ ÈîÄÂîÆÈôêÂà∂</div><div class="alert alert-warning">'; p.salesRestrictions.forEach(function(r) { html += '<div style="padding: 4px 0;"><strong>' + r.country + '</strong> - ' + r.client + '</div>'; }); html += '</div></div>'; }
      if (template) {
        html += '<div class="section"><div class="section-title">ÊäÄÊúØÂèÇÊï∞</div><div class="info-grid">';
        template.parameters.forEach(function(param) { var spec = p.specs ? p.specs[param.fieldKey] : null; var val = "‚Äî"; if (spec != null) val = param.type === "number" ? spec.value + " " + spec.unit : spec; html += '<div class="info-item"><div class="info-label">' + param.label + '</div><div class="info-value">' + val + '</div></div>'; });
        html += '</div></div>';
      }
      if (p.datasheets && p.datasheets.length) {
        html += '<div class="section"><div class="section-title">üìÑ ËßÑÊ†º‰π¶‰∏éÊñáÊ°£</div><div style="display: flex; gap: 12px; flex-wrap: wrap;">';
        p.datasheets.forEach(function(doc) { html += '<div style="background: #F5F6FA; border-radius: 8px; padding: 16px; text-align: center; min-width: 120px;"><div style="font-size: 32px;">' + (doc.icon || 'üìÑ') + '</div><div style="font-size: 13px; font-weight: bold; margin-top: 8px;">' + doc.name + '</div><div style="font-size: 11px; color: #8C8C8C; margin-top: 4px;">' + (doc.filename || 'document.pdf') + '</div><button class="btn btn-sm btn-default" style="margin-top: 8px;">‚¨áÔ∏è ‰∏ãËΩΩ</button></div>'; });
        html += '</div></div>';
      }
      if (p.certifications && p.certifications.length) {
        html += '<div class="section"><div class="section-title">üìú ËÆ§ËØÅ‰ø°ÊÅØ</div><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">';
        p.certifications.forEach(function(c) { html += '<div style="background: #F6FFED; border: 1px solid #B7EB8F; border-radius: 8px; padding: 16px;"><div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 24px;">' + (c.fileIcon || 'üìú') + '</span><div><div style="font-weight: bold; color: #52C41A;">' + c.name + '</div><div style="font-size: 12px; color: #8C8C8C;">' + (c.code || '-') + '</div></div></div>' + (mode === "admin" ? '<div style="margin-top: 8px; font-size: 11px;"><span class="tag ' + (c.public ? 'tag-green' : 'tag-gray') + '">' + (c.public ? 'ÂÖ¨ÂºÄ' : 'ÂÜÖÈÉ®') + '</span></div>' : '') + '</div>'; });
        html += '</div></div>';
      }
      if (mode !== "client" && p.internalNotes && p.internalNotes.collaboration && p.internalNotes.collaboration.length) { html += '<div class="section"><div class="section-title">üí° Âçè‰ΩúÂ§áÊ≥®</div>'; p.internalNotes.collaboration.forEach(function(n) { html += '<div class="alert alert-info"><div style="font-weight: bold;">' + n.icon + ' ' + n.title + '</div><div style="margin-top: 4px;">' + n.content + '</div></div>'; }); html += '</div>'; }
      if (mode === "admin" && p.internalNotes && p.internalNotes.sensitive && p.internalNotes.sensitive.length) { html += '<div class="section"><div class="section-title">üîí Êú∫ÂØÜ‰ø°ÊÅØ</div>'; p.internalNotes.sensitive.forEach(function(n) { html += '<div class="alert alert-error"><div style="font-weight: bold;">' + n.icon + ' ' + n.title + '</div><div style="margin-top: 4px;">' + n.content + '</div></div>'; }); html += '</div>'; }
      html += '</div></div></div></div>';
      renderLayout(html);
    }

    function renderProductEdit(id) {
      var product = id ? getProductById(id) : null;
      var isNew = !product;
      var currentCategoryId = product ? product.categoryId : null;
      state.editingProductMedia = product && product.media ? JSON.parse(JSON.stringify(product.media)) : [];
      state.editingProductDatasheets = product && product.datasheets ? JSON.parse(JSON.stringify(product.datasheets)) : [];
      state.editingProductCerts = product && product.certifications ? JSON.parse(JSON.stringify(product.certifications)) : [];
      var html = '<div class="card"><div class="card-header"><div class="card-title">' + (isNew ? "Êñ∞Â¢û‰∫ßÂìÅ" : "ÁºñËæë‰∫ßÂìÅ") + '</div><div class="card-actions"><button class="btn btn-default" onclick="navigate(\'#/products\')">‚Üê ËøîÂõûÂàóË°®</button></div></div><div class="card-body"><form onsubmit="event.preventDefault(); saveProduct(' + (id || 'null') + ');">';
      html += '<div class="form-row"><div class="form-group"><label class="form-label form-label-required">‰∫ßÂìÅÂêçÁß∞</label><input type="text" id="productName" class="form-input" value="' + (product ? product.name : '') + '" required></div><div class="form-group"><label class="form-label form-label-required">SKU</label><input type="text" id="productSku" class="form-input" value="' + (product ? product.sku : '') + '" required></div></div>';
      html += '<div class="form-row"><div class="form-group"><label class="form-label form-label-required">ÂìÅÁâå</label><input type="text" id="productBrand" class="form-input" value="' + (product ? product.brand : '') + '"></div><div class="form-group"><label class="form-label form-label-required">ÂàÜÁ±ª</label><select id="productCategory" class="form-select" onchange="updateProductSpecsFields()"><option value="">ËØ∑ÈÄâÊã©ÂàÜÁ±ª</option>';
      db.categories.filter(function(c) { return c.parentId !== null; }).forEach(function(c) { html += '<option value="' + c.id + '"' + (product && product.categoryId === c.id ? " selected" : "") + '>' + c.name + '</option>'; });
      html += '</select></div></div>';
      html += '<div class="form-row"><div class="form-group"><label class="form-label">‰æõÂ∫îÂïÜ</label><select id="productVendor" class="form-select"><option value="">ËØ∑ÈÄâÊã©‰æõÂ∫îÂïÜ</option>';
      db.vendors.forEach(function(v) { html += '<option value="' + v.id + '"' + (product && product.vendorId === v.id ? " selected" : "") + '>' + v.name + '</option>'; });
      html += '</select></div><div class="form-group"><label class="form-label">Áä∂ÊÄÅ</label><select id="productStatus" class="form-select"><option value="Âú®ÂîÆ"' + (product && product.status === "Âú®ÂîÆ" ? " selected" : "") + '>Âú®ÂîÆ</option><option value="ÂÅúÂîÆ"' + (product && product.status === "ÂÅúÂîÆ" ? " selected" : "") + '>ÂÅúÂîÆ</option><option value="ÂºÄÂèë‰∏≠"' + (product && product.status === "ÂºÄÂèë‰∏≠" ? " selected" : "") + '>ÂºÄÂèë‰∏≠</option></select></div></div>';
      html += '<div class="form-row-3"><div class="form-group"><label class="form-label">Âá∫ÂéÇ‰ª∑ (USD)</label><input type="number" step="0.01" id="productFactoryPrice" class="form-input" value="' + (product && product.factoryPrice ? product.factoryPrice : '') + '" data-original-price="' + (product && product.factoryPrice ? product.factoryPrice : '') + '" onchange="checkPriceChange()"></div><div class="form-group"><label class="form-label">Â∏ÇÂú∫ÊåáÂØº‰ª∑ (USD)</label><input type="number" step="0.01" id="productMarketPrice" class="form-input" value="' + (product && product.marketGuidePrice ? product.marketGuidePrice : '') + '"></div><div class="form-group"><label class="form-label">MOQ</label><input type="number" id="productMoq" class="form-input" value="' + (product && product.moq ? product.moq : '') + '"></div></div>';
      html += '<div id="priceChangeReasonContainer" style="display: none;"><div class="alert alert-warning" style="margin: 12px 0;"><div style="font-weight: bold; margin-bottom: 8px;">‚ö†Ô∏è Âá∫ÂéÇ‰ª∑ÂèòÊõ¥ÈúÄË¶ÅÂ°´ÂÜôÂéüÂõ†Âπ∂‰∏ä‰º†Âá≠ËØÅ</div><div class="form-group"><label class="form-label form-label-required">ÂèòÊõ¥ÂéüÂõ†</label><input type="text" id="priceChangeReason" class="form-input" placeholder="ËØ∑ËæìÂÖ•‰ª∑Ê†ºÂèòÊõ¥ÂéüÂõ†ÔºåÂ¶ÇÔºö‰æõÂ∫îÂïÜÊ∂®‰ª∑„ÄÅÂéüÊùêÊñôÊàêÊú¨ÂèòÂåñÁ≠â"></div><div class="form-group" style="margin-bottom: 0;"><label class="form-label">ÈôÑ‰ª∂Âá≠ËØÅ <span style="font-weight: normal; color: #8C8C8C;">(Êä•‰ª∑Âçï„ÄÅËÅäÂ§©Êà™ÂõæÁ≠â)</span></label><div id="priceChangeAttachments"></div><button type="button" class="btn btn-sm btn-default" onclick="addPriceChangeAttachment()" style="margin-top: 8px;">üìé Ê∑ªÂä†ÈôÑ‰ª∂</button></div></div></div>';
      if (product && product.priceHistory && product.priceHistory.length > 0) {
        html += '<div class="section" style="margin: 16px 0; padding: 16px; background: #FFFBE6; border: 1px solid #FFE58F; border-radius: 8px;"><div class="section-title" style="margin-bottom: 12px;">üìä Âá∫ÂéÇ‰ª∑ÂèòÊõ¥ÂéÜÂè≤</div><table style="width: 100%; border-collapse: collapse; font-size: 13px;"><thead><tr style="background: #FFF7E6;"><th style="padding: 8px; text-align: left; border-bottom: 1px solid #FFE58F;">‰ª∑Ê†º</th><th style="padding: 8px; text-align: left; border-bottom: 1px solid #FFE58F;">ÁîüÊïàÊó•Êúü</th><th style="padding: 8px; text-align: left; border-bottom: 1px solid #FFE58F;">Â§±ÊïàÊó•Êúü</th><th style="padding: 8px; text-align: left; border-bottom: 1px solid #FFE58F;">Êìç‰Ωú‰∫∫</th><th style="padding: 8px; text-align: left; border-bottom: 1px solid #FFE58F;">ÂèòÊõ¥ÂéüÂõ†</th><th style="padding: 8px; text-align: left; border-bottom: 1px solid #FFE58F;">ÈôÑ‰ª∂</th></tr></thead><tbody>';
        product.priceHistory.forEach(function(h, idx) {
          var isActive = idx === 0 && !h.expiredDate;
          var attHtml = '';
          if (h.attachments && h.attachments.length > 0) {
            h.attachments.forEach(function(a) { attHtml += '<span class="price-attachment">' + a.icon + ' ' + a.name + '</span>'; });
          } else { attHtml = '-'; }
          html += '<tr style="' + (isActive ? 'background: #F6FFED;' : '') + '"><td style="padding: 8px; border-bottom: 1px solid #FFE58F;"><strong style="color: ' + (isActive ? '#52C41A' : '#8C8C8C') + ';">' + formatPrice(h.price) + '</strong>' + (isActive ? ' <span class="tag tag-green" style="font-size: 10px;">ÂΩìÂâç</span>' : '') + '</td><td style="padding: 8px; border-bottom: 1px solid #FFE58F;">' + h.effectiveDate + '</td><td style="padding: 8px; border-bottom: 1px solid #FFE58F; color: ' + (h.expiredDate ? '#FF4D4F' : '#52C41A') + ';">' + (h.expiredDate || 'Ëá≥‰ªäÊúâÊïà') + '</td><td style="padding: 8px; border-bottom: 1px solid #FFE58F;">' + h.operator + '</td><td style="padding: 8px; border-bottom: 1px solid #FFE58F;">' + h.reason + '</td><td style="padding: 8px; border-bottom: 1px solid #FFE58F;">' + attHtml + '</td></tr>';
        });
        html += '</tbody></table></div>';
      }
      html += '<div class="form-group"><label class="form-label">Ê†áÁ≠æ</label><div style="display: flex; gap: 12px; flex-wrap: wrap;">';
      db.tags.forEach(function(t) { html += '<label class="checkbox-item"><input type="checkbox" name="productTags" value="' + t.name + '"' + (product && product.tags && product.tags.indexOf(t.name) !== -1 ? " checked" : "") + '><span class="tag" style="background: ' + t.bgColor + '; color: ' + t.color + '">' + t.name + '</span></label>'; });
      html += '</div></div>';
      html += '<div id="productSpecsContainer">' + renderProductSpecsFields(currentCategoryId, product ? product.specs : null) + '</div>';
      html += '<div class="section-title" style="margin-top: 24px; display: flex; justify-content: space-between; align-items: center;"><span>üì∑ ‰∫ßÂìÅÂõæÁâá‰∏éËßÜÈ¢ë</span><button type="button" class="btn btn-sm btn-primary" onclick="addProductMedia()">‚ûï Ê∑ªÂä†Â™í‰Ωì</button></div>';
      html += '<div id="productMediaContainer">' + renderProductMediaFields() + '</div>';
      html += '<div class="section-title" style="margin-top: 24px; display: flex; justify-content: space-between; align-items: center;"><span>üìÑ ËßÑÊ†º‰π¶‰∏éÊñáÊ°£</span><button type="button" class="btn btn-sm btn-primary" onclick="addProductDatasheet()">‚ûï Ê∑ªÂä†ÊñáÊ°£</button></div>';
      html += '<div id="productDatasheetsContainer">' + renderProductDatasheetsFields() + '</div>';
      html += '<div class="section-title" style="margin-top: 24px; display: flex; justify-content: space-between; align-items: center;"><span>üìú ËÆ§ËØÅÊñá‰ª∂</span><button type="button" class="btn btn-sm btn-primary" onclick="addProductCert()">‚ûï Ê∑ªÂä†ËÆ§ËØÅ</button></div>';
      html += '<div id="productCertsContainer">' + renderProductCertsFields() + '</div>';
      html += '<div class="form-row"><div class="form-group"><label class="form-label">ÂØπÊ†á‰∫ßÂìÅ</label><input type="text" id="productBenchmark" class="form-input" value="' + (product && product.benchmarkProduct ? product.benchmarkProduct : '') + '"></div><div class="form-group"><label class="form-label">ÂØπÊ†áËØ¥Êòé</label><input type="text" id="productBenchmarkContext" class="form-input" value="' + (product && product.benchmarkContext ? product.benchmarkContext : '') + '"></div></div>';
      html += '<div style="margin-top: 24px; display: flex; gap: 12px;"><button type="submit" class="btn btn-primary">üíæ ‰øùÂ≠ò</button><button type="button" class="btn btn-default" onclick="navigate(\'#/products\')">ÂèñÊ∂à</button></div></form></div></div>';
      renderLayout(html);
    }

    function renderProductMediaFields() {
      if (!state.editingProductMedia || state.editingProductMedia.length === 0) {
        return '<div class="alert alert-info" style="margin: 12px 0;">ÊöÇÊó†Â™í‰ΩìÊñá‰ª∂ÔºåÁÇπÂáª"Ê∑ªÂä†Â™í‰Ωì"‰∏ä‰º†ÂõæÁâáÊàñËßÜÈ¢ë</div>';
      }
      var html = '<div style="margin-top: 12px;">';
      state.editingProductMedia.forEach(function(media, index) {
        html += '<div class="list-item" style="margin-bottom: 8px; padding: 12px;"><div style="flex: 1; display: grid; grid-template-columns: 50px 1fr 100px auto; gap: 12px; align-items: center;">';
        html += '<div style="font-size: 28px; text-align: center;">' + (media.url || 'üì∑') + '</div>';
        html += '<input type="text" class="form-input" placeholder="ÂõæÁâá/ËßÜÈ¢ëÊ†áÈ¢ò" value="' + (media.title || '') + '" onchange="updateProductMedia(' + index + ', \'title\', this.value)" style="font-size: 13px;">';
        html += '<select class="form-select" onchange="updateProductMedia(' + index + ', \'type\', this.value)" style="font-size: 13px;"><option value="image"' + (media.type === 'image' ? ' selected' : '') + '>üì∑ ÂõæÁâá</option><option value="video"' + (media.type === 'video' ? ' selected' : '') + '>üé¨ ËßÜÈ¢ë</option></select>';
        html += '<button type="button" class="btn btn-sm btn-danger" onclick="removeProductMedia(' + index + ')">Âà†Èô§</button>';
        html += '</div></div>';
      });
      html += '</div>';
      return html;
    }

    function renderProductDatasheetsFields() {
      if (!state.editingProductDatasheets || state.editingProductDatasheets.length === 0) {
        return '<div class="alert alert-info" style="margin: 12px 0;">ÊöÇÊó†ËßÑÊ†º‰π¶ÔºåÁÇπÂáª"Ê∑ªÂä†ÊñáÊ°£"‰∏ä‰º†ËßÑÊ†º‰π¶ÊàñÊâãÂÜå</div>';
      }
      var html = '<div style="margin-top: 12px;">';
      state.editingProductDatasheets.forEach(function(doc, index) {
        html += '<div class="list-item" style="margin-bottom: 8px; padding: 12px;"><div style="flex: 1; display: grid; grid-template-columns: 40px 1fr 1fr auto; gap: 12px; align-items: center;">';
        html += '<div style="font-size: 24px; text-align: center;">' + (doc.icon || 'üìÑ') + '</div>';
        html += '<input type="text" class="form-input" placeholder="ÊñáÊ°£ÂêçÁß∞" value="' + (doc.name || '') + '" onchange="updateProductDatasheet(' + index + ', \'name\', this.value)" style="font-size: 13px;">';
        html += '<input type="text" class="form-input" placeholder="Êñá‰ª∂Âêç (Â¶Ç: spec.pdf)" value="' + (doc.filename || '') + '" onchange="updateProductDatasheet(' + index + ', \'filename\', this.value)" style="font-size: 13px;">';
        html += '<button type="button" class="btn btn-sm btn-danger" onclick="removeProductDatasheet(' + index + ')">Âà†Èô§</button>';
        html += '</div></div>';
      });
      html += '</div>';
      return html;
    }

    function renderProductCertsFields() {
      if (!state.editingProductCerts || state.editingProductCerts.length === 0) {
        return '<div class="alert alert-info" style="margin: 12px 0;">ÊöÇÊó†ËÆ§ËØÅÊñá‰ª∂ÔºåÁÇπÂáª"Ê∑ªÂä†ËÆ§ËØÅ"ÂΩïÂÖ•ËÆ§ËØÅ‰ø°ÊÅØ</div>';
      }
      var html = '<div style="margin-top: 12px;">';
      state.editingProductCerts.forEach(function(cert, index) {
        html += '<div class="list-item" style="margin-bottom: 8px; padding: 12px;"><div style="flex: 1; display: grid; grid-template-columns: 40px 120px 1fr 80px auto; gap: 12px; align-items: center;">';
        html += '<div style="font-size: 24px; text-align: center;">üìú</div>';
        html += '<input type="text" class="form-input" placeholder="ËÆ§ËØÅÂêçÁß∞" value="' + (cert.name || '') + '" onchange="updateProductCert(' + index + ', \'name\', this.value)" style="font-size: 13px;">';
        html += '<input type="text" class="form-input" placeholder="ËØÅ‰π¶ÁºñÂè∑" value="' + (cert.code || '') + '" onchange="updateProductCert(' + index + ', \'code\', this.value)" style="font-size: 13px;">';
        html += '<label class="checkbox-item" style="font-size: 12px;"><input type="checkbox"' + (cert.public ? ' checked' : '') + ' onchange="updateProductCert(' + index + ', \'public\', this.checked)"><span>ÂÖ¨ÂºÄ</span></label>';
        html += '<button type="button" class="btn btn-sm btn-danger" onclick="removeProductCert(' + index + ')">Âà†Èô§</button>';
        html += '</div></div>';
      });
      html += '</div>';
      return html;
    }

    function addProductMedia() {
      var icons = ['üì∑', 'üñºÔ∏è', 'üé¨', 'üìπ'];
      state.editingProductMedia.push({ type: 'image', title: '', url: icons[Math.floor(Math.random() * 2)] });
      document.getElementById("productMediaContainer").innerHTML = renderProductMediaFields();
    }
    function updateProductMedia(index, field, value) {
      if (state.editingProductMedia[index]) {
        state.editingProductMedia[index][field] = value;
        if (field === 'type') { state.editingProductMedia[index].url = value === 'video' ? 'üé¨' : 'üì∑'; document.getElementById("productMediaContainer").innerHTML = renderProductMediaFields(); }
      }
    }
    function removeProductMedia(index) { state.editingProductMedia.splice(index, 1); document.getElementById("productMediaContainer").innerHTML = renderProductMediaFields(); }

    function addProductDatasheet() {
      state.editingProductDatasheets.push({ name: '', filename: '', icon: 'üìÑ' });
      document.getElementById("productDatasheetsContainer").innerHTML = renderProductDatasheetsFields();
    }
    function updateProductDatasheet(index, field, value) { if (state.editingProductDatasheets[index]) state.editingProductDatasheets[index][field] = value; }
    function removeProductDatasheet(index) { state.editingProductDatasheets.splice(index, 1); document.getElementById("productDatasheetsContainer").innerHTML = renderProductDatasheetsFields(); }

    function addProductCert() {
      state.editingProductCerts.push({ name: '', code: '', public: true, fileIcon: 'üìú' });
      document.getElementById("productCertsContainer").innerHTML = renderProductCertsFields();
    }
    function updateProductCert(index, field, value) { if (state.editingProductCerts[index]) state.editingProductCerts[index][field] = value; }
    function removeProductCert(index) { state.editingProductCerts.splice(index, 1); document.getElementById("productCertsContainer").innerHTML = renderProductCertsFields(); }

    function renderProductSpecsFields(categoryId, existingSpecs) {
      if (!categoryId) return '<div class="alert alert-info" style="margin: 16px 0;">ËØ∑ÂÖàÈÄâÊã©ÂàÜÁ±ª‰ª•ÊòæÁ§∫ÊäÄÊúØÂèÇÊï∞Â≠óÊÆµ</div>';
      var category = getCategoryById(parseInt(categoryId));
      if (!category || !category.templateKey) return '<div class="alert alert-info" style="margin: 16px 0;">ÂΩìÂâçÂàÜÁ±ªÊú™ÂÖ≥ËÅîÂèÇÊï∞Ê®°Êùø</div>';
      var template = getTemplateByKey(category.templateKey);
      if (!template || !template.parameters || template.parameters.length === 0) return '<div class="alert alert-info" style="margin: 16px 0;">ÂΩìÂâçÂàÜÁ±ªÂÖ≥ËÅîÁöÑÊ®°ÊùøÊöÇÊó†ÂèÇÊï∞ÈÖçÁΩÆ</div>';
      var html = '<div class="section" style="margin: 24px 0; padding: 20px; background: #FAFAFA; border-radius: 8px;"><div class="section-title" style="margin-bottom: 16px;">üìã ÊäÄÊúØÂèÇÊï∞ (' + template.name + ')</div><div class="info-grid">';
      template.parameters.forEach(function(param) {
        var existingValue = existingSpecs && existingSpecs[param.fieldKey];
        var value = '';
        if (existingValue) {
          value = param.type === 'number' ? (existingValue.value || '') : existingValue;
        }
        html += '<div class="form-group"><label class="form-label' + (param.required ? ' form-label-required' : '') + '">' + param.label + (param.unit ? ' (' + param.unit + ')' : '') + '</label>';
        if (param.type === 'number') {
          html += '<input type="number" step="any" class="form-input" id="spec_' + param.fieldKey + '" data-field="' + param.fieldKey + '" data-type="number" data-unit="' + (param.unit || '') + '" value="' + value + '"' + (param.required ? ' required' : '') + '>';
        } else {
          html += '<input type="text" class="form-input" id="spec_' + param.fieldKey + '" data-field="' + param.fieldKey + '" data-type="text" value="' + value + '"' + (param.required ? ' required' : '') + '>';
        }
        html += '</div>';
      });
      html += '</div></div>';
      return html;
    }

    function updateProductSpecsFields() {
      var categoryId = document.getElementById("productCategory").value;
      document.getElementById("productSpecsContainer").innerHTML = renderProductSpecsFields(categoryId, null);
    }

    function collectProductSpecs() {
      var specs = {};
      var specInputs = document.querySelectorAll('[id^="spec_"]');
      specInputs.forEach(function(input) {
        var fieldKey = input.getAttribute('data-field');
        var type = input.getAttribute('data-type');
        var unit = input.getAttribute('data-unit');
        var value = input.value;
        if (value) {
          if (type === 'number') {
            specs[fieldKey] = { value: parseFloat(value), unit: unit || '' };
          } else {
            specs[fieldKey] = value;
          }
        }
      });
      return specs;
    }

    function checkPriceChange() {
      var input = document.getElementById("productFactoryPrice");
      var originalPrice = parseFloat(input.getAttribute("data-original-price")) || 0;
      var newPrice = parseFloat(input.value) || 0;
      var container = document.getElementById("priceChangeReasonContainer");
      if (originalPrice !== newPrice && originalPrice > 0) {
        container.style.display = "block";
        document.getElementById("priceChangeReason").required = true;
        state.editingPriceAttachments = [];
        renderPriceChangeAttachments();
      } else {
        container.style.display = "none";
        document.getElementById("priceChangeReason").required = false;
        state.editingPriceAttachments = [];
      }
    }

    function renderPriceChangeAttachments() {
      var container = document.getElementById("priceChangeAttachments");
      if (!container) return;
      if (state.editingPriceAttachments.length === 0) {
        container.innerHTML = '<div style="color: #8C8C8C; font-size: 12px;">ÊöÇÊó†ÈôÑ‰ª∂</div>';
        return;
      }
      var html = '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">';
      state.editingPriceAttachments.forEach(function(att, idx) {
        html += '<div style="display: flex; align-items: center; gap: 6px; background: #F5F6FA; padding: 6px 10px; border-radius: 4px;">';
        html += '<span>' + att.icon + '</span><span style="font-size: 12px;">' + att.name + '</span>';
        html += '<span onclick="removePriceChangeAttachment(' + idx + ')" style="cursor: pointer; color: #FF4D4F; font-size: 14px;">√ó</span>';
        html += '</div>';
      });
      html += '</div>';
      container.innerHTML = html;
    }

    function addPriceChangeAttachment() {
      var icons = ['üìÑ', 'üñºÔ∏è', 'üìä', 'üìù'];
      var types = ['Êä•‰ª∑Âçï.pdf', 'ËÅäÂ§©Êà™Âõæ.png', '‰ª∑Ê†ºÁ°ÆËÆ§ÂáΩ.xlsx', 'ÈÇÆ‰ª∂ËÆ∞ÂΩï.pdf'];
      var randomIdx = Math.floor(Math.random() * icons.length);
      var fileName = prompt('ËØ∑ËæìÂÖ•ÈôÑ‰ª∂Êñá‰ª∂ÂêçÔºö', types[randomIdx]);
      if (fileName) {
        state.editingPriceAttachments.push({ name: fileName, icon: fileName.endsWith('.png') || fileName.endsWith('.jpg') ? 'üñºÔ∏è' : fileName.endsWith('.xlsx') ? 'üìä' : 'üìÑ' });
        renderPriceChangeAttachments();
      }
    }

    function removePriceChangeAttachment(idx) {
      state.editingPriceAttachments.splice(idx, 1);
      renderPriceChangeAttachments();
    }

    function saveProduct(id) {
      var name = document.getElementById("productName").value;
      var sku = document.getElementById("productSku").value;
      var brand = document.getElementById("productBrand").value;
      var categoryId = parseInt(document.getElementById("productCategory").value) || null;
      var vendorId = parseInt(document.getElementById("productVendor").value) || null;
      var status = document.getElementById("productStatus").value;
      var factoryPrice = parseFloat(document.getElementById("productFactoryPrice").value) || null;
      var marketGuidePrice = parseFloat(document.getElementById("productMarketPrice").value) || null;
      var moq = parseInt(document.getElementById("productMoq").value) || null;
      var benchmarkProduct = document.getElementById("productBenchmark").value;
      var benchmarkContext = document.getElementById("productBenchmarkContext").value;
      var tags = Array.from(document.querySelectorAll('input[name="productTags"]:checked')).map(function(cb) { return cb.value; });
      var specs = collectProductSpecs();
      var media = state.editingProductMedia.filter(function(m) { return m.title; });
      var datasheets = state.editingProductDatasheets.filter(function(d) { return d.name; });
      var certifications = state.editingProductCerts.filter(function(c) { return c.name; });
      
      var priceChangeReason = document.getElementById("priceChangeReason") ? document.getElementById("priceChangeReason").value : "";
      var today = new Date().toISOString().split("T")[0];
      
      if (id) {
        var product = getProductById(id);
        if (product) {
          var oldPrice = product.factoryPrice;
          var priceHistory = product.priceHistory || [];
          
          if (factoryPrice !== oldPrice && oldPrice) {
            if (!priceChangeReason) {
              showToast("ËØ∑Â°´ÂÜôÂá∫ÂéÇ‰ª∑ÂèòÊõ¥ÂéüÂõ†ÔºÅ", "error");
              return;
            }
            if (priceHistory.length > 0 && !priceHistory[0].expiredDate) {
              priceHistory[0].expiredDate = today;
            }
            priceHistory.unshift({
              price: factoryPrice,
              effectiveDate: today,
              operator: state.currentUser ? state.currentUser.realName : "admin",
              reason: priceChangeReason,
              attachments: state.editingPriceAttachments.slice()
            });
          }
          
          Object.assign(product, { name: name, sku: sku, brand: brand, categoryId: categoryId, vendorId: vendorId, status: status, factoryPrice: factoryPrice, marketGuidePrice: marketGuidePrice, moq: moq, benchmarkProduct: benchmarkProduct, benchmarkContext: benchmarkContext, tags: tags, specs: specs, media: media, datasheets: datasheets, certifications: certifications, priceHistory: priceHistory });
          showToast("‰∫ßÂìÅÊõ¥Êñ∞ÊàêÂäüÔºÅ");
        }
      } else {
        var newPriceHistory = [];
        if (factoryPrice) {
          newPriceHistory.push({
            price: factoryPrice,
            effectiveDate: today,
            operator: state.currentUser ? state.currentUser.realName : "admin",
            reason: "Êñ∞ÂìÅÂàùÂßãÂÆö‰ª∑",
            attachments: []
          });
        }
        var newProduct = { id: getNextId(db.products), name: name, sku: sku, brand: brand, categoryId: categoryId, vendorId: vendorId, status: status, factoryPrice: factoryPrice, marketGuidePrice: marketGuidePrice, moq: moq, benchmarkProduct: benchmarkProduct, benchmarkContext: benchmarkContext, tags: tags, media: media.length > 0 ? media : [{ type: "image", title: "‰∫ßÂìÅÂõæ", url: "üì¶" }], datasheets: datasheets, specs: specs, certifications: certifications, priceHistory: newPriceHistory, salesRestrictions: [], internalNotes: { collaboration: [], sensitive: [] } };
        db.products.push(newProduct);
        showToast("‰∫ßÂìÅÂàõÂª∫ÊàêÂäüÔºÅ");
      }
      state.editingProductMedia = []; state.editingProductDatasheets = []; state.editingProductCerts = []; state.editingPriceAttachments = [];
      navigate("#/products");
    }

    function renderProductCompare() {
      var hash = window.location.hash;
      var mode = "admin", backPath = "#/products";
      if (hash.indexOf("#/sales/") === 0) { mode = "sales"; backPath = "#/sales/products"; }
      if (hash.indexOf("#/client/") === 0) { mode = "client"; backPath = "#/client/products"; }
      var products = state.selectedProductIds.map(function(id) { var p = getProductById(id); return p ? filterByRole(p, "product") : null; }).filter(function(p) { return p; });
      if (products.length === 0) { renderLayout('<div class="card"><div class="card-body"><div class="placeholder-page"><div class="placeholder-icon">‚öñÔ∏è</div><div class="placeholder-title">‰∫ßÂìÅÂØπÊØî</div><div class="placeholder-desc">ËøòÊ≤°ÊúâÈÄâÊã©ÂØπÊØî‰∫ßÂìÅÔºåËØ∑ËøîÂõûÂàóË°®ÈÄâÊã©2-8‰∏™‰∫ßÂìÅ</div><div class="placeholder-actions"><button class="btn btn-primary" onclick="navigate(\'' + backPath + '\')">‚Üê ËøîÂõûÂàóË°®</button></div></div></div></div>'); return; }
      var paramsMap = {};
      products.forEach(function(p) { var cat = getCategoryById(p.categoryId); var tpl = cat && cat.templateKey ? getTemplateByKey(cat.templateKey) : null; if (tpl) tpl.parameters.forEach(function(param) { if (!paramsMap[param.fieldKey]) paramsMap[param.fieldKey] = param; }); });

      var html = '<div class="card"><div class="card-header"><div><div class="card-title">‰∫ßÂìÅÂØπÊØî</div><div class="card-subtitle">Ê≠£Âú®ÂØπÊØî ' + products.length + ' ‰∏™‰∫ßÂìÅ</div></div><div class="card-actions"><button class="btn btn-default" onclick="navigate(\'' + backPath + '\')">‚Üê ËøîÂõûÂàóË°®</button><button class="btn btn-default" onclick="state.selectedProductIds = []; navigate(\'' + backPath + '\')">üóëÔ∏è Ê∏ÖÁ©∫ÂØπÊØî</button></div></div><div class="card-body"><div class="compare-container"><table class="compare-table"><thead><tr><th style="min-width: 150px;">ÂèÇÊï∞</th>';
      products.forEach(function(p) { html += '<th><div class="compare-product-header"><div class="compare-product-icon">' + (p.media && p.media[0] ? p.media[0].url : "üì¶") + '</div><div class="compare-product-name">' + p.name + '</div><div class="compare-product-sku">' + p.sku + '</div><div class="compare-remove" onclick="removeFromCompare(' + p.id + ')">ÁßªÈô§</div></div></th>'; });
      html += '</tr></thead><tbody>';
      if (mode !== "client") { html += '<tr style="background: #FFF7E6;"><td><strong>Â∏ÇÂú∫ÊåáÂØº‰ª∑</strong></td>'; products.forEach(function(p) { html += '<td style="text-align: center; font-size: 18px; font-weight: bold; color: #1890FF;">' + (p.marketGuidePrice ? formatPrice(p.marketGuidePrice) : "‚Äî") + '</td>'; }); html += '</tr>'; }
      if (mode === "admin") { html += '<tr style="background: #FFF1F0;"><td><strong>üîí Âá∫ÂéÇ‰ª∑</strong></td>'; products.forEach(function(p) { html += '<td style="text-align: center; font-size: 18px; font-weight: bold; color: #FF4D4F;">' + (p.factoryPrice ? formatPrice(p.factoryPrice) : "‚Äî") + '</td>'; }); html += '</tr>'; html += '<tr style="background: #FFF1F0;"><td><strong>üîí MOQ</strong></td>'; products.forEach(function(p) { html += '<td style="text-align: center;">' + (p.moq ? p.moq + " pcs" : "‚Äî") + '</td>'; }); html += '</tr>'; }
      if (mode !== "client") { html += '<tr style="background: #E6F7FF;"><td><strong>üéØ ÂØπÊ†á‰∫ßÂìÅ</strong></td>'; products.forEach(function(p) { html += '<td style="text-align: center;">' + (p.benchmarkProduct || "‚Äî") + '</td>'; }); html += '</tr>'; }
      Object.keys(paramsMap).forEach(function(key) { var param = paramsMap[key]; html += '<tr><td><strong>' + param.label + '</strong></td>'; products.forEach(function(p) { var spec = p.specs ? p.specs[param.fieldKey] : null; var val = "‚Äî"; if (spec != null) val = param.type === "number" ? spec.value + " " + spec.unit : spec; html += '<td style="text-align: center;">' + val + '</td>'; }); html += '</tr>'; });
      html += '</tbody></table></div></div></div>';
      renderLayout(html);
    }

    function removeFromCompare(id) { var idx = state.selectedProductIds.indexOf(id); if (idx > -1) state.selectedProductIds.splice(idx, 1); router(); }

    function renderVendorList() {
      var avgRating = db.vendors.reduce(function(a, v) { return a + v.rating; }, 0) / db.vendors.length;
      var avgLeadTime = Math.round(db.vendors.reduce(function(a, v) { return a + v.avgLeadTime; }, 0) / db.vendors.length);
      var html = '<div class="stat-cards"><div class="stat-card"><div class="stat-card-icon">üè≠</div><div class="stat-card-value">' + db.vendors.length + '</div><div class="stat-card-label">‰æõÂ∫îÂïÜÊÄªÊï∞</div></div><div class="stat-card"><div class="stat-card-icon">üì¶</div><div class="stat-card-value">' + db.products.length + '</div><div class="stat-card-label">‰∫ßÂìÅÊÄªÊï∞</div></div><div class="stat-card"><div class="stat-card-icon">‚≠ê</div><div class="stat-card-value">' + avgRating.toFixed(1) + '</div><div class="stat-card-label">Âπ≥ÂùáËØÑÂàÜ</div></div><div class="stat-card"><div class="stat-card-icon">üìÖ</div><div class="stat-card-value">' + avgLeadTime + '</div><div class="stat-card-label">Âπ≥Âùá‰∫§Êúü(Â§©)</div></div></div>';
      html += '<div class="card"><div class="card-header"><div><div class="card-title">‰æõÂ∫îÂïÜÂàóË°®</div><div class="card-subtitle">ÂÖ± ' + db.vendors.length + ' ÂÆ∂‰æõÂ∫îÂïÜ</div></div><div class="card-actions"><button class="btn btn-primary" onclick="navigate(\'#/vendor-edit\')">‚ûï Êñ∞Â¢û‰æõÂ∫îÂïÜ</button></div></div></div>';
      html += '<div class="grid grid-3">';
      db.vendors.forEach(function(v) {
        html += '<div class="vendor-card" onclick="navigate(\'#/vendor/' + v.id + '\')"><div class="vendor-card-header"><div class="vendor-card-icon">' + v.icon + '</div><div class="vendor-card-name">' + v.name + '</div></div><div class="vendor-card-body"><div class="vendor-card-info"><div class="vendor-card-info-item"><span>üìç</span><span>' + v.location.city + '</span></div><div class="vendor-card-info-item"><span>‚≠ê</span><span class="vendor-card-rating">';
        for (var i = 0; i < 5; i++) html += i < v.rating ? "‚òÖ" : "‚òÜ";
        html += '</span></div><div class="vendor-card-info-item"><span>üì¶</span><span>' + v.productCount + ' ‰∏™‰∫ßÂìÅ</span></div><div class="vendor-card-info-item"><span>ü§ù</span><span>Âêà‰Ωú ' + v.cooperationYears + ' Âπ¥</span></div></div><div class="vendor-card-tags">';
        v.mainCategories.slice(0, 3).forEach(function(c) { html += '<span class="tag tag-blue">' + c + '</span>'; });
        html += '</div></div></div>';
      });
      html += '</div>';
      renderLayout(html);
    }

    function renderVendorDetail(id) {
      var vendor = getVendorById(id);
      if (!vendor) return render404();
      var vendorProducts = db.products.filter(function(p) { return p.vendorId === vendor.id; });
      var html = '<div class="card"><div class="card-header"><div><div class="card-title">' + vendor.icon + ' ' + vendor.name + '</div><div class="card-subtitle">ÊàêÁ´ã‰∫é ' + vendor.established + ' Âπ¥ ¬∑ Âêà‰Ωú ' + vendor.cooperationYears + ' Âπ¥</div></div><div class="card-actions"><button class="btn btn-default" onclick="navigate(\'#/vendors\')">‚Üê ËøîÂõûÂàóË°®</button><button class="btn btn-primary" onclick="navigate(\'#/vendor-edit/' + id + '\')">‚úèÔ∏è ÁºñËæë</button></div></div><div class="card-body">';
      var stars = ""; for (var i = 0; i < 5; i++) stars += i < vendor.rating ? "‚òÖ" : "‚òÜ";
      html += '<div class="section"><div class="section-title">Âü∫Êú¨‰ø°ÊÅØ</div><div class="info-grid"><div class="info-item"><div class="info-label">ÂÖ¨Âè∏ÂÖ®Áß∞</div><div class="info-value">' + vendor.name + '</div></div><div class="info-item"><div class="info-label">ËØÑÂàÜ</div><div class="info-value" style="color: #FAAD14;">' + stars + '</div></div><div class="info-item"><div class="info-label">ÊâÄÂú®Âú∞Âå∫</div><div class="info-value">' + vendor.location.province + ' ' + vendor.location.city + ' ' + vendor.location.district + '</div></div><div class="info-item"><div class="info-label">ËØ¶ÁªÜÂú∞ÂùÄ</div><div class="info-value">' + vendor.address + '</div></div><div class="info-item"><div class="info-label">Âπ≥Âùá‰∫§Êúü</div><div class="info-value">' + vendor.avgLeadTime + ' Â§©</div></div><div class="info-item"><div class="info-label">‰∫ßÂìÅÊï∞Èáè</div><div class="info-value">' + vendor.productCount + ' ‰∏™</div></div></div></div>';
      html += '<div class="section"><div class="section-title">üîí Êú∫ÂØÜ‰ø°ÊÅØ (‰ªÖÁÆ°ÁêÜÂëòÂèØËßÅ)</div><div class="alert alert-warning"><div class="info-grid"><div class="info-item"><div class="info-label">Ê≥ï‰∫∫‰ª£Ë°®</div><div class="info-value">' + vendor.adminOnly.legalPerson + '</div></div><div class="info-item"><div class="info-label">Ê≥®ÂÜåËµÑÊú¨</div><div class="info-value">' + formatMoney(vendor.adminOnly.capitalCNY) + '</div></div><div class="info-item"><div class="info-label">ÂëòÂ∑•ËßÑÊ®°</div><div class="info-value">' + vendor.adminOnly.employeesRange.min + '-' + vendor.adminOnly.employeesRange.max + ' ‰∫∫</div></div><div class="info-item"><div class="info-label">ËÅîÁ≥ª‰∫∫</div><div class="info-value">' + vendor.adminOnly.contact.person + ' (' + vendor.adminOnly.contact.position + ')</div></div><div class="info-item"><div class="info-label">ÁîµËØù</div><div class="info-value">' + vendor.adminOnly.contact.phone + '</div></div><div class="info-item"><div class="info-label">ÊâãÊú∫</div><div class="info-value">' + vendor.adminOnly.contact.mobile + '</div></div><div class="info-item"><div class="info-label">ÈÇÆÁÆ±</div><div class="info-value">' + vendor.adminOnly.contact.email + '</div></div></div></div></div>';
      html += '<div class="section"><div class="section-title">‰∏ªËê•Á±ªÁõÆ</div><div style="display: flex; gap: 8px; flex-wrap: wrap;">'; vendor.mainCategories.forEach(function(c) { html += '<span class="tag tag-blue">' + c + '</span>'; }); html += '</div></div>';
      html += '<div class="section"><div class="section-title">Âêà‰ΩúÂìÅÁâå</div><div style="display: flex; gap: 8px; flex-wrap: wrap;">'; vendor.cooperatedBrands.forEach(function(b) { html += '<span class="tag tag-purple">' + b + '</span>'; }); html += '</div></div>';
      html += '<div class="section"><div class="section-title">Â∑•ÂéÇËÆ§ËØÅ</div><div style="display: flex; gap: 8px; flex-wrap: wrap;">'; vendor.factoryCerts.forEach(function(c) { html += '<span class="tag tag-green">' + c + '</span>'; }); html += '</div></div>';
      html += '<div class="section"><div class="section-title">‰∫ßÂìÅÂêàËßÑÁªèÈ™å</div><div style="display: flex; gap: 8px; flex-wrap: wrap;">'; vendor.productComplianceExperience.forEach(function(c) { html += '<span class="tag tag-cyan">' + c + '</span>'; }); html += '</div></div>';
      if (vendor.media && vendor.media.length > 0) {
        var images = vendor.media.filter(function(m) { return m.type === 'image'; });
        var videos = vendor.media.filter(function(m) { return m.type === 'video'; });
        html += '<div class="section"><div class="section-title">üì∑ Â∑•ÂéÇÂõæÁâá (' + images.length + ')</div><div class="grid grid-4">';
        images.forEach(function(m) { html += '<div style="background: #F5F6FA; border-radius: 8px; padding: 20px; text-align: center;"><div style="font-size: 64px; margin-bottom: 8px;">' + m.url + '</div><div style="font-size: 13px; color: #595959;">' + m.title + '</div></div>'; });
        html += '</div></div>';
        if (videos.length > 0) {
          html += '<div class="section"><div class="section-title">üé¨ Â∑•ÂéÇËßÜÈ¢ë (' + videos.length + ')</div><div class="grid grid-3">';
          videos.forEach(function(m) { html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; padding: 24px; text-align: center; color: #fff;"><div style="font-size: 48px; margin-bottom: 8px;">' + m.url + '</div><div style="font-size: 14px;">' + m.title + '</div><button class="btn btn-default" style="margin-top: 12px; background: rgba(255,255,255,0.2); border-color: #fff; color: #fff;">‚ñ∂ Êí≠ÊîæËßÜÈ¢ë</button></div>'; });
          html += '</div></div>';
        }
      }
      html += '<div class="section"><div class="section-title">‰æõÂ∫î‰∫ßÂìÅ (' + vendorProducts.length + ')</div><div class="grid grid-4">';
      vendorProducts.forEach(function(p) { html += '<div class="product-card" onclick="navigate(\'#/product/' + p.id + '\')"><div class="product-card-image" style="height: 120px; font-size: 48px;">' + (p.media && p.media[0] ? p.media[0].url : "üì¶") + '</div><div class="product-card-body"><div class="product-card-name" style="font-size: 14px;">' + p.name + '</div><div class="product-card-sku">' + p.sku + '</div></div></div>'; });
      html += '</div></div></div></div>';
      renderLayout(html);
    }

    function renderVendorEdit(id) {
      var vendor = id ? getVendorById(id) : null;
      var isNew = !vendor;
      var html = '<div class="card"><div class="card-header"><div class="card-title">' + (isNew ? "Êñ∞Â¢û‰æõÂ∫îÂïÜ" : "ÁºñËæë‰æõÂ∫îÂïÜ") + '</div><div class="card-actions"><button class="btn btn-default" onclick="navigate(\'#/vendors\')">‚Üê ËøîÂõûÂàóË°®</button></div></div><div class="card-body"><form onsubmit="event.preventDefault(); saveVendor(' + (id || 'null') + ');">';
      html += '<div class="form-row"><div class="form-group"><label class="form-label form-label-required">ÂÖ¨Âè∏ÂêçÁß∞</label><input type="text" id="vendorName" class="form-input" value="' + (vendor ? vendor.name : '') + '" required></div><div class="form-group"><label class="form-label">ËØÑÂàÜ</label><select id="vendorRating" class="form-select">';
      for (var r = 1; r <= 5; r++) html += '<option value="' + r + '"' + (vendor && vendor.rating === r ? " selected" : "") + '>' + r + ' Êòü</option>';
      html += '</select></div></div>';
      html += '<div class="form-row-3"><div class="form-group"><label class="form-label">ÁúÅ‰ªΩ</label><input type="text" id="vendorProvince" class="form-input" value="' + (vendor && vendor.location ? vendor.location.province : '') + '"></div><div class="form-group"><label class="form-label">ÂüéÂ∏Ç</label><input type="text" id="vendorCity" class="form-input" value="' + (vendor && vendor.location ? vendor.location.city : '') + '"></div><div class="form-group"><label class="form-label">Âå∫Âéø</label><input type="text" id="vendorDistrict" class="form-input" value="' + (vendor && vendor.location ? vendor.location.district : '') + '"></div></div>';
      html += '<div class="form-group"><label class="form-label">ËØ¶ÁªÜÂú∞ÂùÄ</label><input type="text" id="vendorAddress" class="form-input" value="' + (vendor ? vendor.address : '') + '"></div>';
      html += '<div class="form-row-3"><div class="form-group"><label class="form-label">ÊàêÁ´ãÂπ¥‰ªΩ</label><input type="number" id="vendorEstablished" class="form-input" value="' + (vendor ? vendor.established : '') + '"></div><div class="form-group"><label class="form-label">Âêà‰ΩúÂπ¥Èôê</label><input type="number" id="vendorCoopYears" class="form-input" value="' + (vendor ? vendor.cooperationYears : '') + '"></div><div class="form-group"><label class="form-label">Âπ≥Âùá‰∫§Êúü(Â§©)</label><input type="number" id="vendorLeadTime" class="form-input" value="' + (vendor ? vendor.avgLeadTime : '') + '"></div></div>';
      html += '<div class="section-title" style="margin-top: 24px;">Êú∫ÂØÜËÅîÁ≥ª‰ø°ÊÅØ</div>';
      html += '<div class="form-row"><div class="form-group"><label class="form-label">Ê≥ï‰∫∫‰ª£Ë°®</label><input type="text" id="vendorLegalPerson" class="form-input" value="' + (vendor && vendor.adminOnly ? vendor.adminOnly.legalPerson : '') + '"></div><div class="form-group"><label class="form-label">Ê≥®ÂÜåËµÑÊú¨(ÂÖÉ)</label><input type="number" id="vendorCapital" class="form-input" value="' + (vendor && vendor.adminOnly ? vendor.adminOnly.capitalCNY : '') + '"></div></div>';
      html += '<div class="form-row"><div class="form-group"><label class="form-label">ËÅîÁ≥ª‰∫∫</label><input type="text" id="vendorContactPerson" class="form-input" value="' + (vendor && vendor.adminOnly && vendor.adminOnly.contact ? vendor.adminOnly.contact.person : '') + '"></div><div class="form-group"><label class="form-label">ËÅå‰Ωç</label><input type="text" id="vendorContactPosition" class="form-input" value="' + (vendor && vendor.adminOnly && vendor.adminOnly.contact ? vendor.adminOnly.contact.position : '') + '"></div></div>';
      html += '<div class="form-row"><div class="form-group"><label class="form-label">ÁîµËØù</label><input type="text" id="vendorContactPhone" class="form-input" value="' + (vendor && vendor.adminOnly && vendor.adminOnly.contact ? vendor.adminOnly.contact.phone : '') + '"></div><div class="form-group"><label class="form-label">ÊâãÊú∫</label><input type="text" id="vendorContactMobile" class="form-input" value="' + (vendor && vendor.adminOnly && vendor.adminOnly.contact ? vendor.adminOnly.contact.mobile : '') + '"></div></div>';
      html += '<div class="form-group"><label class="form-label">ÈÇÆÁÆ±</label><input type="email" id="vendorContactEmail" class="form-input" value="' + (vendor && vendor.adminOnly && vendor.adminOnly.contact ? vendor.adminOnly.contact.email : '') + '"></div>';
      state.editingVendorMedia = vendor && vendor.media ? JSON.parse(JSON.stringify(vendor.media)) : [];
      html += '<div class="section-title" style="margin-top: 24px; display: flex; justify-content: space-between; align-items: center;"><span>üì∑ ÂõæÁâá‰∏éËßÜÈ¢ë</span><button type="button" class="btn btn-sm btn-primary" onclick="addVendorMedia()">‚ûï Ê∑ªÂä†Â™í‰Ωì</button></div>';
      html += '<div id="vendorMediaContainer">' + renderVendorMediaFields() + '</div>';
      html += '<div style="margin-top: 24px; display: flex; gap: 12px;"><button type="submit" class="btn btn-primary">üíæ ‰øùÂ≠ò</button><button type="button" class="btn btn-default" onclick="navigate(\'#/vendors\')">ÂèñÊ∂à</button></div></form></div></div>';
      renderLayout(html);
    }

    function renderVendorMediaFields() {
      if (!state.editingVendorMedia || state.editingVendorMedia.length === 0) {
        return '<div class="alert alert-info" style="margin-top: 12px;">ÊöÇÊó†Â™í‰ΩìÔºåÁÇπÂáª"Ê∑ªÂä†Â™í‰Ωì"ÊåâÈíÆ‰∏ä‰º†ÂõæÁâáÊàñËßÜÈ¢ë</div>';
      }
      var html = '<div style="margin-top: 12px;">';
      state.editingVendorMedia.forEach(function(media, index) {
        html += '<div class="list-item" style="margin-bottom: 8px; padding: 12px;">';
        html += '<div style="flex: 1; display: grid; grid-template-columns: 60px 1fr 120px auto; gap: 12px; align-items: center;">';
        html += '<div style="font-size: 32px; text-align: center;">' + (media.url || 'üì∑') + '</div>';
        html += '<input type="text" class="form-input" placeholder="Ê†áÈ¢òÊèèËø∞" value="' + (media.title || '') + '" onchange="updateVendorMedia(' + index + ', \'title\', this.value)" style="font-size: 13px;">';
        html += '<select class="form-select" onchange="updateVendorMedia(' + index + ', \'type\', this.value)" style="font-size: 13px;"><option value="image"' + (media.type === 'image' ? ' selected' : '') + '>üì∑ ÂõæÁâá</option><option value="video"' + (media.type === 'video' ? ' selected' : '') + '>üé¨ ËßÜÈ¢ë</option></select>';
        html += '<button type="button" class="btn btn-sm btn-danger" onclick="removeVendorMedia(' + index + ')">Âà†Èô§</button>';
        html += '</div></div>';
      });
      html += '</div>';
      return html;
    }

    function addVendorMedia() {
      var icons = ['üè≠', '‚öôÔ∏è', 'üîß', 'üî¨', 'üí°', 'üì¶', 'üé¨'];
      var randomIcon = icons[Math.floor(Math.random() * icons.length)];
      state.editingVendorMedia.push({ type: 'image', title: '', url: randomIcon });
      document.getElementById("vendorMediaContainer").innerHTML = renderVendorMediaFields();
    }

    function updateVendorMedia(index, field, value) {
      if (state.editingVendorMedia[index]) {
        state.editingVendorMedia[index][field] = value;
        if (field === 'type') {
          state.editingVendorMedia[index].url = value === 'video' ? 'üé¨' : 'üè≠';
          document.getElementById("vendorMediaContainer").innerHTML = renderVendorMediaFields();
        }
      }
    }

    function removeVendorMedia(index) {
      state.editingVendorMedia.splice(index, 1);
      document.getElementById("vendorMediaContainer").innerHTML = renderVendorMediaFields();
    }

    function saveVendor(id) {
      var name = document.getElementById("vendorName").value;
      var rating = parseInt(document.getElementById("vendorRating").value);
      var province = document.getElementById("vendorProvince").value;
      var city = document.getElementById("vendorCity").value;
      var district = document.getElementById("vendorDistrict").value;
      var address = document.getElementById("vendorAddress").value;
      var established = parseInt(document.getElementById("vendorEstablished").value) || 2020;
      var cooperationYears = parseInt(document.getElementById("vendorCoopYears").value) || 1;
      var avgLeadTime = parseInt(document.getElementById("vendorLeadTime").value) || 30;
      var legalPerson = document.getElementById("vendorLegalPerson").value;
      var capitalCNY = parseInt(document.getElementById("vendorCapital").value) || 0;
      var contactPerson = document.getElementById("vendorContactPerson").value;
      var contactPosition = document.getElementById("vendorContactPosition").value;
      var contactPhone = document.getElementById("vendorContactPhone").value;
      var contactMobile = document.getElementById("vendorContactMobile").value;
      var contactEmail = document.getElementById("vendorContactEmail").value;
      var media = state.editingVendorMedia.filter(function(m) { return m.title; });
      var vendorData = { name: name, icon: "üè≠", rating: rating, established: established, cooperationYears: cooperationYears, avgLeadTime: avgLeadTime, address: address, location: { province: province, city: city, district: district }, mainCategories: [], cooperatedBrands: [], factoryCerts: [], productComplianceExperience: [], productCount: 0, media: media, adminOnly: { legalPerson: legalPerson, capitalCNY: capitalCNY, employeesRange: { min: 50, max: 100 }, contact: { person: contactPerson, position: contactPosition, phone: contactPhone, mobile: contactMobile, email: contactEmail } } };
      if (id) { var vendor = getVendorById(id); if (vendor) { Object.assign(vendor, vendorData); showToast("‰æõÂ∫îÂïÜÊõ¥Êñ∞ÊàêÂäüÔºÅ"); } }
      else { vendorData.id = getNextId(db.vendors); db.vendors.push(vendorData); showToast("‰æõÂ∫îÂïÜÂàõÂª∫ÊàêÂäüÔºÅ"); }
      state.editingVendorMedia = [];
      navigate("#/vendors");
    }

    function renderSettings(key) {
      var tabs = [{ key: "categories", label: "üìÅ ÂàÜÁ±ªÁÆ°ÁêÜ" }, { key: "tags", label: "üè∑Ô∏è Ê†áÁ≠æÁÆ°ÁêÜ" }, { key: "templates", label: "üìã ÂèÇÊï∞Ê®°Êùø" }, { key: "users", label: "üë• Áî®Êà∑ÁÆ°ÁêÜ" }];
      var content = "";
      if (key === "categories") content = renderCategoriesSettings();
      else if (key === "tags") content = renderTagsSettings();
      else if (key === "templates") content = renderTemplatesSettings();
      else if (key === "users") content = renderUsersSettings();
      var html = '<div class="card"><div class="card-header"><div class="card-title">‚öôÔ∏è Á≥ªÁªüËÆæÁΩÆ</div></div><div class="card-body"><div class="tabs">';
      tabs.forEach(function(t) { html += '<div class="tab' + (key === t.key ? " active" : "") + '" onclick="navigate(\'#/settings/' + t.key + '\')">' + t.label + '</div>'; });
      html += '</div>' + content + '</div></div>';
      renderLayout(html);
    }

    function renderCategoriesSettings() {
      var parentCategories = db.categories.filter(function(c) { return c.parentId === null; });
      var html = '<div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;"><div class="card-subtitle">ÁÆ°ÁêÜ‰∫ßÂìÅÂàÜÁ±ªÂ±ÇÁ∫ßÁªìÊûÑ</div><button class="btn btn-primary" onclick="openCategoryModal()">‚ûï Êñ∞Â¢ûÂàÜÁ±ª</button></div>';
      parentCategories.forEach(function(parent) {
        var children = db.categories.filter(function(c) { return c.parentId === parent.id; });
        html += '<div class="list-item"><div class="list-item-content"><div style="font-weight: bold; font-size: 16px;">üìÅ ' + parent.name + '</div><div style="color: #8C8C8C; font-size: 13px; margin-top: 4px;">ÊéíÂ∫è: ' + parent.sortOrder + ' ¬∑ ' + (parent.enabled ? "‚úÖ ÂêØÁî®" : "‚ùå Á¶ÅÁî®") + '</div></div><div class="list-item-actions"><button class="btn btn-sm btn-default" onclick="openCategoryModal(' + parent.id + ')">ÁºñËæë</button><button class="btn btn-sm btn-danger" onclick="deleteCategory(' + parent.id + ')">Âà†Èô§</button></div></div>';
        children.forEach(function(child) { html += '<div class="list-item list-item-indent"><div class="list-item-content"><div style="font-weight: 500;">‚îî ' + child.name + '</div><div style="color: #8C8C8C; font-size: 13px; margin-top: 4px;">ÊéíÂ∫è: ' + child.sortOrder + ' ¬∑ Ê®°Êùø: ' + (child.templateKey || "Êó†") + ' ¬∑ ' + (child.enabled ? "‚úÖ ÂêØÁî®" : "‚ùå Á¶ÅÁî®") + '</div></div><div class="list-item-actions"><button class="btn btn-sm btn-default" onclick="openCategoryModal(' + child.id + ')">ÁºñËæë</button><button class="btn btn-sm btn-danger" onclick="deleteCategory(' + child.id + ')">Âà†Èô§</button></div></div>'; });
      });
      return html;
    }

    function renderTagsSettings() {
      var html = '<div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;"><div class="card-subtitle">ÁÆ°ÁêÜ‰∫ßÂìÅÊ†áÁ≠æÂíåÂèØËßÅÊÄß</div><button class="btn btn-primary" onclick="openTagModal()">‚ûï Êñ∞Â¢ûÊ†áÁ≠æ</button></div>';
      db.tags.forEach(function(tag) { html += '<div class="list-item"><div class="list-item-content"><div style="display: flex; align-items: center; gap: 12px;"><span class="tag" style="background: ' + tag.bgColor + '; color: ' + tag.color + '">' + tag.name + '</span><span style="color: #8C8C8C; font-size: 13px;">ÂàÜÁªÑ: ' + tag.group + '</span></div><div style="color: #8C8C8C; font-size: 13px; margin-top: 8px;">ÂèØËßÅ: ' + tag.visibleTo.join(", ") + ' ¬∑ ' + (tag.enabled ? "‚úÖ ÂêØÁî®" : "‚ùå Á¶ÅÁî®") + '</div></div><div class="list-item-actions"><button class="btn btn-sm btn-default" onclick="openTagModal(' + tag.id + ')">ÁºñËæë</button><button class="btn btn-sm btn-danger" onclick="deleteTag(' + tag.id + ')">Âà†Èô§</button></div></div>'; });
      return html;
    }

    function renderTemplatesSettings() {
      var html = '<div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;"><div class="card-subtitle">ÁÆ°ÁêÜ‰∫ßÂìÅÂèÇÊï∞Ê®°Êùø</div><button class="btn btn-primary" onclick="openTemplateModal()">‚ûï Êñ∞Â¢ûÊ®°Êùø</button></div>';
      db.templates.forEach(function(tpl) { html += '<div class="list-item"><div class="list-item-content"><div style="font-weight: bold;">' + tpl.name + '</div><div style="color: #8C8C8C; font-size: 13px; margin-top: 4px;">Key: ' + tpl.templateKey + ' ¬∑ ' + tpl.parameters.length + ' ‰∏™ÂèÇÊï∞ ¬∑ ' + (tpl.enabled ? "‚úÖ ÂêØÁî®" : "‚ùå Á¶ÅÁî®") + '</div><div style="margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap;">' + tpl.parameters.map(function(p) { return '<span class="tag tag-gray">' + p.label + ' (' + (p.unit || '-') + ')</span>'; }).join("") + '</div></div><div class="list-item-actions"><button class="btn btn-sm btn-default" onclick="openTemplateModal(' + tpl.id + ')">ÁºñËæë</button><button class="btn btn-sm btn-danger" onclick="deleteTemplate(' + tpl.id + ')">Âà†Èô§</button></div></div>'; });
      return html;
    }

    function renderUsersSettings() {
      var html = '<div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;"><div class="card-subtitle">ÁÆ°ÁêÜÁ≥ªÁªüÁî®Êà∑Ë¥¶Âè∑</div><button class="btn btn-primary" onclick="openUserModal()">‚ûï Êñ∞Â¢ûÁî®Êà∑</button></div><div class="table-wrapper"><table><thead><tr><th>Â§¥ÂÉè</th><th>Áî®Êà∑Âêç</th><th>ÂßìÂêç</th><th>ËßíËâ≤</th><th>ÁîµËØù</th><th>ÈÇÆÁÆ±</th><th>Áä∂ÊÄÅ</th><th>Êìç‰Ωú</th></tr></thead><tbody>';
      db.users.forEach(function(u) { html += '<tr><td><div class="topbar-avatar" style="background: ' + u.avatarBg + '">' + u.avatar + '</div></td><td>' + u.username + '</td><td>' + u.realName + '</td><td><span class="tag ' + (u.role === 'admin' ? 'tag-purple' : 'tag-blue') + '">' + (u.role === 'admin' ? 'ÁÆ°ÁêÜÂëò' : '‰∏öÂä°Âëò') + '</span></td><td>' + (u.phone || '-') + '</td><td>' + (u.email || '-') + '</td><td><span class="tag ' + (u.status === 'active' ? 'tag-green' : 'tag-gray') + '">' + (u.status === 'active' ? 'ÂêØÁî®' : 'Á¶ÅÁî®') + '</span></td><td><button class="btn btn-sm btn-default" onclick="openUserModal(' + u.id + ')">ÁºñËæë</button> <button class="btn btn-sm btn-danger" onclick="deleteUser(' + u.id + ')">Âà†Èô§</button></td></tr>'; });
      html += '</tbody></table></div>';
      return html;
    }

    function openCategoryModal(id) {
      var cat = id ? getCategoryById(id) : null;
      state.editingItem = cat; state.editingType = "category";
      document.getElementById("editModalTitle").textContent = cat ? "ÁºñËæëÂàÜÁ±ª" : "Êñ∞Â¢ûÂàÜÁ±ª";
      var html = '<div class="form-group"><label class="form-label form-label-required">ÂàÜÁ±ªÂêçÁß∞</label><input type="text" id="editCatName" class="form-input" value="' + (cat ? cat.name : '') + '"></div>';
      html += '<div class="form-group"><label class="form-label">‰∏äÁ∫ßÂàÜÁ±ª</label><select id="editCatParent" class="form-select"><option value="">Êó† (‰∏ÄÁ∫ßÂàÜÁ±ª)</option>';
      db.categories.filter(function(c) { return c.parentId === null && c.id !== id; }).forEach(function(c) { html += '<option value="' + c.id + '"' + (cat && cat.parentId === c.id ? " selected" : "") + '>' + c.name + '</option>'; });
      html += '</select></div><div class="form-row"><div class="form-group"><label class="form-label">ÊéíÂ∫è</label><input type="number" id="editCatSort" class="form-input" value="' + (cat ? cat.sortOrder : 1) + '"></div><div class="form-group"><label class="form-label">Ê®°ÊùøKey</label><input type="text" id="editCatTemplate" class="form-input" value="' + (cat && cat.templateKey ? cat.templateKey : '') + '"></div></div>';
      html += '<div class="form-group"><label class="checkbox-item"><input type="checkbox" id="editCatEnabled"' + (cat === null || cat.enabled !== false ? " checked" : "") + '><span>ÂêØÁî®</span></label></div>';
      document.getElementById("editModalBody").innerHTML = html;
      document.getElementById("editModal").classList.add("active");
    }

    function openTagModal(id) {
      var tag = id ? db.tags.find(function(t) { return t.id === id; }) : null;
      state.editingItem = tag; state.editingType = "tag";
      document.getElementById("editModalTitle").textContent = tag ? "ÁºñËæëÊ†áÁ≠æ" : "Êñ∞Â¢ûÊ†áÁ≠æ";
      var html = '<div class="form-row"><div class="form-group"><label class="form-label form-label-required">Ê†áÁ≠æÂêçÁß∞</label><input type="text" id="editTagName" class="form-input" value="' + (tag ? tag.name : '') + '"></div><div class="form-group"><label class="form-label">ÂàÜÁªÑ</label><select id="editTagGroup" class="form-select"><option value="feature"' + (tag && tag.group === 'feature' ? ' selected' : '') + '>ÂäüËÉΩÁâπÊÄß</option><option value="strategy"' + (tag && tag.group === 'strategy' ? ' selected' : '') + '>Á≠ñÁï•</option><option value="status"' + (tag && tag.group === 'status' ? ' selected' : '') + '>Áä∂ÊÄÅ</option><option value="certification"' + (tag && tag.group === 'certification' ? ' selected' : '') + '>ËÆ§ËØÅ</option></select></div></div>';
      html += '<div class="form-row"><div class="form-group"><label class="form-label">È¢úËâ≤</label><input type="color" id="editTagColor" class="form-input" value="' + (tag ? tag.color : '#1890FF') + '" style="height: 40px;"></div><div class="form-group"><label class="form-label">ËÉåÊôØËâ≤</label><input type="color" id="editTagBgColor" class="form-input" value="' + (tag ? tag.bgColor : '#E6F7FF') + '" style="height: 40px;"></div></div>';
      html += '<div class="form-group"><label class="form-label">ÂèØËßÅÊÄß</label><div style="display: flex; gap: 16px;"><label class="checkbox-item"><input type="checkbox" name="editTagVisible" value="admin"' + (tag === null || (tag.visibleTo && tag.visibleTo.indexOf('admin') !== -1) ? ' checked' : '') + '> ÁÆ°ÁêÜÂëò</label><label class="checkbox-item"><input type="checkbox" name="editTagVisible" value="sales"' + (tag === null || (tag.visibleTo && tag.visibleTo.indexOf('sales') !== -1) ? ' checked' : '') + '> ‰∏öÂä°Âëò</label><label class="checkbox-item"><input type="checkbox" name="editTagVisible" value="client"' + (tag && tag.visibleTo && tag.visibleTo.indexOf('client') !== -1 ? ' checked' : '') + '> ÂÆ¢Êà∑</label></div></div>';
      html += '<div class="form-group"><label class="checkbox-item"><input type="checkbox" id="editTagEnabled"' + (tag === null || tag.enabled !== false ? " checked" : "") + '><span>ÂêØÁî®</span></label></div>';
      document.getElementById("editModalBody").innerHTML = html;
      document.getElementById("editModal").classList.add("active");
    }

    function openTemplateModal(id) {
      var tpl = id ? db.templates.find(function(t) { return t.id === id; }) : null;
      state.editingItem = tpl; state.editingType = "template";
      state.editingParams = tpl ? JSON.parse(JSON.stringify(tpl.parameters)) : [];
      document.getElementById("editModalTitle").textContent = tpl ? "ÁºñËæëÊ®°Êùø" : "Êñ∞Â¢ûÊ®°Êùø";
      var html = '<div class="form-row"><div class="form-group"><label class="form-label form-label-required">Ê®°ÊùøÂêçÁß∞</label><input type="text" id="editTplName" class="form-input" value="' + (tpl ? tpl.name : '') + '"></div><div class="form-group"><label class="form-label form-label-required">Ê®°ÊùøKey</label><input type="text" id="editTplKey" class="form-input" value="' + (tpl ? tpl.templateKey : '') + '"></div></div>';
      html += '<div class="form-group"><label class="checkbox-item"><input type="checkbox" id="editTplEnabled"' + (tpl === null || tpl.enabled !== false ? " checked" : "") + '><span>ÂêØÁî®</span></label></div>';
      html += '<div class="section-title" style="margin-top: 16px; display: flex; justify-content: space-between; align-items: center;"><span>ÂèÇÊï∞ÂàóË°®</span><button type="button" class="btn btn-sm btn-primary" onclick="addTemplateParam()">‚ûï Ê∑ªÂä†ÂèÇÊï∞</button></div>';
      html += '<div id="templateParamsContainer">' + renderTemplateParams() + '</div>';
      document.getElementById("editModalBody").innerHTML = html;
      document.getElementById("editModal").classList.add("active");
    }

    function renderTemplateParams() {
      if (!state.editingParams || state.editingParams.length === 0) {
        return '<div class="alert alert-info" style="margin-top: 12px;">ÊöÇÊó†ÂèÇÊï∞ÔºåÁÇπÂáª"Ê∑ªÂä†ÂèÇÊï∞"ÊåâÈíÆÂàõÂª∫Êñ∞ÂèÇÊï∞</div>';
      }
      var html = '<div style="margin-top: 12px;">';
      state.editingParams.forEach(function(param, index) {
        html += '<div class="list-item" style="margin-bottom: 8px; padding: 12px;">';
        html += '<div style="flex: 1; display: grid; grid-template-columns: repeat(5, 1fr) auto; gap: 8px; align-items: center;">';
        html += '<input type="text" class="form-input" placeholder="Â≠óÊÆµKey" value="' + (param.fieldKey || '') + '" onchange="updateTemplateParam(' + index + ', \'fieldKey\', this.value)" style="font-size: 13px;">';
        html += '<input type="text" class="form-input" placeholder="ÊòæÁ§∫ÂêçÁß∞" value="' + (param.label || '') + '" onchange="updateTemplateParam(' + index + ', \'label\', this.value)" style="font-size: 13px;">';
        html += '<select class="form-select" onchange="updateTemplateParam(' + index + ', \'type\', this.value)" style="font-size: 13px;"><option value="number"' + (param.type === 'number' ? ' selected' : '') + '>Êï∞Â≠ó</option><option value="text"' + (param.type === 'text' ? ' selected' : '') + '>ÊñáÊú¨</option></select>';
        html += '<input type="text" class="form-input" placeholder="Âçï‰Ωç" value="' + (param.unit || '') + '" onchange="updateTemplateParam(' + index + ', \'unit\', this.value)" style="font-size: 13px;">';
        html += '<label class="checkbox-item" style="font-size: 13px;"><input type="checkbox"' + (param.required ? ' checked' : '') + ' onchange="updateTemplateParam(' + index + ', \'required\', this.checked)"><span>ÂøÖÂ°´</span></label>';
        html += '<button type="button" class="btn btn-sm btn-danger" onclick="removeTemplateParam(' + index + ')">Âà†Èô§</button>';
        html += '</div></div>';
      });
      html += '</div>';
      return html;
    }

    function addTemplateParam() {
      state.editingParams.push({ fieldKey: '', label: '', type: 'number', unit: '', required: false });
      document.getElementById("templateParamsContainer").innerHTML = renderTemplateParams();
    }

    function updateTemplateParam(index, field, value) {
      if (state.editingParams[index]) {
        state.editingParams[index][field] = value;
      }
    }

    function removeTemplateParam(index) {
      state.editingParams.splice(index, 1);
      document.getElementById("templateParamsContainer").innerHTML = renderTemplateParams();
    }

    function openUserModal(id) {
      var user = id ? getUserById(id) : null;
      state.editingItem = user; state.editingType = "user";
      document.getElementById("editModalTitle").textContent = user ? "ÁºñËæëÁî®Êà∑" : "Êñ∞Â¢ûÁî®Êà∑";
      var html = '<div class="form-row"><div class="form-group"><label class="form-label form-label-required">Áî®Êà∑Âêç</label><input type="text" id="editUserUsername" class="form-input" value="' + (user ? user.username : '') + '"></div><div class="form-group"><label class="form-label form-label-required">ÂßìÂêç</label><input type="text" id="editUserRealName" class="form-input" value="' + (user ? user.realName : '') + '"></div></div>';
      html += '<div class="form-row"><div class="form-group"><label class="form-label">ÂØÜÁ†Å</label><input type="password" id="editUserPassword" class="form-input" placeholder="' + (user ? 'ÁïôÁ©∫Âàô‰∏ç‰øÆÊîπ' : 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å') + '"></div><div class="form-group"><label class="form-label">ËßíËâ≤</label><select id="editUserRole" class="form-select"><option value="admin"' + (user && user.role === 'admin' ? ' selected' : '') + '>ÁÆ°ÁêÜÂëò</option><option value="sales"' + (user && user.role === 'sales' ? ' selected' : '') + '>‰∏öÂä°Âëò</option></select></div></div>';
      html += '<div class="form-row"><div class="form-group"><label class="form-label">ÁîµËØù</label><input type="text" id="editUserPhone" class="form-input" value="' + (user ? user.phone : '') + '"></div><div class="form-group"><label class="form-label">ÈÇÆÁÆ±</label><input type="email" id="editUserEmail" class="form-input" value="' + (user ? user.email : '') + '"></div></div>';
      html += '<div class="form-group"><label class="form-label">Áä∂ÊÄÅ</label><select id="editUserStatus" class="form-select"><option value="active"' + (user && user.status === 'active' ? ' selected' : '') + '>ÂêØÁî®</option><option value="inactive"' + (user && user.status === 'inactive' ? ' selected' : '') + '>Á¶ÅÁî®</option></select></div>';
      document.getElementById("editModalBody").innerHTML = html;
      document.getElementById("editModal").classList.add("active");
    }

    function closeEditModal() { document.getElementById("editModal").classList.remove("active"); state.editingItem = null; state.editingType = null; state.editingParams = []; }

    function saveEdit() {
      var type = state.editingType, item = state.editingItem;
      if (type === "category") {
        var name = document.getElementById("editCatName").value;
        var parentId = document.getElementById("editCatParent").value ? parseInt(document.getElementById("editCatParent").value) : null;
        var sortOrder = parseInt(document.getElementById("editCatSort").value) || 1;
        var templateKey = document.getElementById("editCatTemplate").value || null;
        var enabled = document.getElementById("editCatEnabled").checked;
        if (item) Object.assign(item, { name: name, parentId: parentId, sortOrder: sortOrder, templateKey: templateKey, enabled: enabled });
        else db.categories.push({ id: getNextId(db.categories), name: name, parentId: parentId, sortOrder: sortOrder, templateKey: templateKey, enabled: enabled });
        showToast("ÂàÜÁ±ª‰øùÂ≠òÊàêÂäüÔºÅ");
      } else if (type === "tag") {
        var name = document.getElementById("editTagName").value;
        var group = document.getElementById("editTagGroup").value;
        var color = document.getElementById("editTagColor").value;
        var bgColor = document.getElementById("editTagBgColor").value;
        var visibleTo = Array.from(document.querySelectorAll('input[name="editTagVisible"]:checked')).map(function(cb) { return cb.value; });
        var enabled = document.getElementById("editTagEnabled").checked;
        if (item) Object.assign(item, { name: name, group: group, color: color, bgColor: bgColor, visibleTo: visibleTo, enabled: enabled });
        else db.tags.push({ id: getNextId(db.tags), name: name, group: group, color: color, bgColor: bgColor, visibleTo: visibleTo, applicableTo: ["product"], enabled: enabled });
        showToast("Ê†áÁ≠æ‰øùÂ≠òÊàêÂäüÔºÅ");
      } else if (type === "template") {
        var name = document.getElementById("editTplName").value;
        var templateKey = document.getElementById("editTplKey").value;
        var enabled = document.getElementById("editTplEnabled").checked;
        var parameters = state.editingParams.filter(function(p) { return p.fieldKey && p.label; });
        if (item) Object.assign(item, { name: name, templateKey: templateKey, enabled: enabled, parameters: parameters });
        else db.templates.push({ id: getNextId(db.templates), name: name, templateKey: templateKey, enabled: enabled, parameters: parameters });
        state.editingParams = [];
        showToast("Ê®°Êùø‰øùÂ≠òÊàêÂäüÔºÅ");
      } else if (type === "user") {
        var username = document.getElementById("editUserUsername").value;
        var realName = document.getElementById("editUserRealName").value;
        var password = document.getElementById("editUserPassword").value;
        var role = document.getElementById("editUserRole").value;
        var phone = document.getElementById("editUserPhone").value;
        var email = document.getElementById("editUserEmail").value;
        var status = document.getElementById("editUserStatus").value;
        if (item) { Object.assign(item, { username: username, realName: realName, role: role, phone: phone, email: email, status: status }); if (password) item.demoPassword = password; }
        else { var avatar = realName.charAt(0); var colors = ["#1890FF", "#52C41A", "#FA8C16", "#722ED1", "#13C2C2"]; db.users.push({ id: getNextId(db.users), username: username, realName: realName, demoPassword: password || "123456", role: role, phone: phone, email: email, status: status, avatar: avatar, avatarBg: colors[db.users.length % colors.length] }); }
        showToast("Áî®Êà∑‰øùÂ≠òÊàêÂäüÔºÅ");
      }
      closeEditModal(); router();
    }

    function deleteCategory(id) { if (!confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂàÜÁ±ªÂêóÔºü")) return; var idx = db.categories.findIndex(function(c) { return c.id === id; }); if (idx > -1) { db.categories.splice(idx, 1); db.categories = db.categories.filter(function(c) { return c.parentId !== id; }); showToast("ÂàÜÁ±ªÂà†Èô§ÊàêÂäüÔºÅ"); router(); } }
    function deleteTag(id) { if (!confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ê†áÁ≠æÂêóÔºü")) return; var idx = db.tags.findIndex(function(t) { return t.id === id; }); if (idx > -1) { db.tags.splice(idx, 1); showToast("Ê†áÁ≠æÂà†Èô§ÊàêÂäüÔºÅ"); router(); } }
    function deleteTemplate(id) { if (!confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ê®°ÊùøÂêóÔºü")) return; var idx = db.templates.findIndex(function(t) { return t.id === id; }); if (idx > -1) { db.templates.splice(idx, 1); showToast("Ê®°ÊùøÂà†Èô§ÊàêÂäüÔºÅ"); router(); } }
    function deleteUser(id) { if (!confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Áî®Êà∑ÂêóÔºü")) return; var idx = db.users.findIndex(function(u) { return u.id === id; }); if (idx > -1) { db.users.splice(idx, 1); showToast("Áî®Êà∑Âà†Èô§ÊàêÂäüÔºÅ"); router(); } }

    function render404() { var homePath = state.currentRole === "sales" ? "#/sales/products" : "#/products"; renderLayout('<div class="placeholder-page"><div class="placeholder-icon">‚ùå</div><div class="placeholder-title">È°µÈù¢Êú™ÊâæÂà∞</div><div class="placeholder-desc">404 - Not Found</div><div class="placeholder-actions"><button class="btn btn-primary" onclick="navigate(\'' + homePath + '\')">ËøîÂõûÈ¶ñÈ°µ</button></div></div>'); }

    window.addEventListener("hashchange", router);
    window.addEventListener("load", router);
  </script>
</body>
</html>
